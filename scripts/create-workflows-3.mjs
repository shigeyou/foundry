const BASE = "http://localhost:3006";

const workflows = [
  {
    name: "決裁取得フロー",
    department: "経営企画部",
    content: `# 決裁取得フロー

## 概要
社内の各種案件について、起案から決裁完了までの稟議・決裁プロセス。投資案件、契約案件、人事案件、規程改定等、案件種別に応じて決裁権限者が異なる。金額・影響度に応じた多段階承認を経る。

## 業務ステップ

### 1. 起案準備（起案部門）
- 案件の整理・起案理由の明確化（部門内での検討・根回し）
- 稟議書の作成（社内所定のWordテンプレートに記入）
- 添付資料の作成（見積書、比較表、費用対効果分析等をExcel/PPTで作成）
- 予算確認（部門予算残高をExcel台帳で確認）
- 関連部門への事前相談（メール or 口頭）
- 上長への事前説明（口頭ブリーフィング、資料印刷して説明）

### 2. 部門内承認（起案部門）
- 課長の確認・承認（紙の稟議書に押印）
- 部門長の確認・承認（紙の稟議書に押印）
- 必要に応じて修正・差し戻し（口頭で指示→起案者が修正→再提出）
- 関連部門の合議（紙の稟議書を物理的に回覧、各部門長が押印）

### 3. 経営企画部チェック（経営企画部）
- 稟議書の形式チェック（記載漏れ、添付書類の確認）
- 予算との整合性確認（予算管理Excelと突合）
- 決裁権限の確認（決裁権限規程と照合、金額帯に応じて決裁者を特定）
- 不備がある場合は起案部門に差し戻し（メール or 電話）

### 4. 決裁者承認（決裁権限者）
- 決裁者への稟議書提出（紙を秘書経由で提出、または直接持参）
- 決裁者の確認・検討（資料読み込み、必要に応じて説明依頼）
- 承認 or 差し戻し or 却下（紙に押印、またはコメント記入）
- 取締役会付議が必要な案件は取締役会議案として上程
- 条件付き承認の場合は条件事項の記録

### 5. 決裁完了処理（経営企画部）
- 決裁番号の採番（連番をExcel台帳で管理）
- 決裁書原本の保管（紙ファイル、年度別キャビネット）
- 起案部門への決裁完了通知（メール）
- 決裁台帳への記録（Excel、日付・案件名・金額・決裁者を入力）
- 関連部門への通知（必要に応じてメール）

### 6. 事後フォロー（経営企画部 + 起案部門）
- 条件付き承認事項の履行確認（メールで起案部門にフォロー）
- 執行状況の確認（予算執行との照合、四半期ごと）
- 年度末の決裁実績集計・分析（Excel）
- 決裁権限規程の見直し（年次）

## 現在の課題
- 紙の稟議書を物理的に回覧するため、承認に1〜3週間かかる
- 出張・外出中の決裁者がいると回覧が滞留する
- 合議先が複数部門にまたがると回覧ルートが複雑化
- 稟議書の現在位置（誰の手元にあるか）が分からない
- 差し戻し時に最初から回覧し直す必要がある
- 過去の決裁案件の検索が紙ファイルの目視探索で困難`,
  },
  {
    name: "人事考課フロー",
    department: "人事部",
    content: `# 人事考課フロー

## 概要
年2回（上期・下期）の人事評価プロセス。目標設定→中間面談→期末評価→評価調整→フィードバックの一連の流れ。陸上職約300名、海上職約200名が対象。海上職は乗船中の評価取得に特殊な対応が必要。

## 業務ステップ

### 1. 目標設定期間（人事部 + 各部門）
- 人事部から目標設定開始の通知（メール配信、Excelテンプレート添付）
- 従業員が目標設定シート（Excel）に記入
- 上長との面談（対面30分、目標のすり合わせ）
- 目標の修正・確定（Excel修正→メール提出）
- 人事部で目標シートの回収・保管（共有フォルダにExcel保存）
- 提出遅延者への督促（メール個別送信）

### 2. 中間面談（各部門）
- 人事部から中間面談実施の案内（メール）
- 各部門で面談日程調整（メール or 口頭）
- 面談実施（対面、進捗確認と軌道修正）
- 面談記録の作成（Excel目標シートにコメント追記）
- 海上職：乗船中の場合は衛星メール or 入港時に実施

### 3. 期末自己評価（全従業員）
- 人事部から自己評価開始の通知（メール、期限指定）
- 従業員が自己評価を記入（Excelの目標シートに実績・自己評価を追記）
- 上長へメール提出
- 海上職：船上からExcelを衛星メール送信（ファイルサイズ制限あり）
- 提出期限管理・督促（人事部がExcelで提出状況を管理、個別メール催促）

### 4. 一次評価（直属上長）
- 部下の自己評価を確認
- 一次評価コメント・評点の記入（Excel）
- 評価面談の実施（対面30-60分、評価内容の説明とフィードバック）
- 海上職の一次評価：船長が乗船中に評価→下船時に提出
- 評価済みExcelを二次評価者（部門長）にメール転送

### 5. 二次評価・評価調整（部門長 + 人事部）
- 部門長の二次評価（Excel記入）
- 部門内の評価バランス調整（部門長がExcelで一覧化して分布確認）
- 人事部での全社評価調整会議（各部門長が参加、Excel投影して議論）
- 評価分布の正規化（S/A/B/C/Dの人数枠に調整）
- 調整結果のExcel反映

### 6. 評価確定・フィードバック（人事部 + 各部門）
- 最終評価の経営層承認（評価一覧表を紙で回覧、社長押印）
- 昇給・賞与への反映データ作成（人事部がExcelで算定）
- 上長から部下への最終フィードバック面談（対面）
- 評価結果通知書の作成・配布（Wordで個別作成→印刷→手渡し）
- 評価シートの最終保管（紙ファイル + 共有フォルダ）

## 現在の課題
- 目標設定シートがExcelで、フォーマット崩れや記入ミスが多い
- 提出状況の管理が手動（人事担当がExcelで全員分チェック）
- 海上職の評価取得が乗船スケジュールに左右され遅延しがち
- 評価調整会議が丸一日かかる（Excelベースの分布調整が非効率）
- 過年度の評価履歴の参照が困難（共有フォルダの目視探索）
- 全プロセスで2ヶ月以上かかり、タイムリーなフィードバックができない`,
  },
  {
    name: "訓練施設見学フロー",
    department: "訓練部",
    content: `# 訓練施設見学フロー

## 概要
操船シミュレータ施設等の見学・体験に関する受入れ業務フロー。顧客企業の研修担当者、教育機関、官公庁、外国船社などからの見学申込みに対応。年間約100件の見学対応。営業活動としても重要。

## 業務ステップ

### 1. 見学申込み受付（訓練部・営業窓口）
- 見学希望の問合せ受領（電話/メール/Webサイト問合せフォーム）
- 見学目的・希望日時・人数・参加者情報のヒアリング（メール往復）
- 申込書（Excel）の記入依頼→回収
- 外国からの場合は英語対応（メール翻訳しながらやり取り）
- 見学可否の判断（シミュレータ稼働スケジュールとの調整）
- 機密性の確認（競合他社の場合は上長判断が必要）

### 2. 日程調整・準備（訓練部）
- シミュレータの空き状況確認（予約管理Excelを参照）
- インストラクターの確保（スケジュール調整、メール or 口頭）
- 見学コースの設計（標準コース or カスタマイズ、PPTで説明資料作成）
- 通訳手配（外国語対応の場合、社内通訳 or 外部手配）
- 来場案内の作成・送付（アクセス情報、持ち物等をメール送付）
- セキュリティ入館証の事前準備（受付に名前リストをFAX/メール）
- デモシナリオの準備（シミュレータの設定変更、インストラクターと打合せ）

### 3. 見学当日対応（訓練部）
- 来場者の受付・入館手続き（受付で名札配布、記名台帳に署名）
- 施設案内・安全説明（口頭、パンフレット配布）
- シミュレータデモ実施（インストラクターが操作・説明、通常60-90分）
- 体験操船の実施（希望者、インストラクター付き添い）
- 質疑応答
- 見学アンケート記入依頼（紙）
- 記念撮影・名刺交換
- お見送り

### 4. 事後対応（訓練部 + 営業部）
- お礼メールの送付（翌営業日）
- 写真データの送付（メール添付）
- アンケート結果の集計（紙からExcelに手入力）
- 見学報告書の作成（Wordテンプレート、社内共有用）
- 商談に繋がる場合は営業部に引継ぎ（メール + 口頭ブリーフィング）
- 見学台帳への記録（Excel、日時・企業名・人数・目的を記入）

### 5. 定期分析・改善（訓練部）
- 月次/四半期の見学実績集計（Excel）
- アンケート結果の分析（満足度、改善要望の傾向、Excel集計）
- 見学コンテンツの改善検討
- 営業部への成約状況フィードバック確認

## 現在の課題
- 申込み〜日程確定までメール往復が多く1〜2週間かかる
- シミュレータの空き状況確認が予約管理Excelの目視チェック
- 外国語対応の通訳手配が直前になりがち
- アンケートが紙ベースで集計が手動
- 見学→商談→成約の追跡ができていない
- 見学実績データの分析が四半期ごとの手動集計のみ`,
  },
  {
    name: "海事業務部 船籍変更フロー",
    department: "海事業務部",
    content: `# 海事業務部 船籍変更フロー

## 概要
船舶の船籍（旗国）変更に伴う各種手続き業務。パナマ籍→日本籍、リベリア籍→マーシャル籍等、船主の事業戦略・規制対応に基づく船籍変更を代行。国際条約・旗国法令・船級規則が絡む複雑な手続き。年間10〜20件程度。

## 業務ステップ

### 1. 船籍変更計画（海事業務担当 + 船主）
- 船主から船籍変更の相談受領（メール/会議）
- 変更理由・目的の確認（税制、規制、運航エリア等）
- 新旧旗国の法令・条約要件の調査（各国海事局のWebサイト、過去案件のファイル参照）
- 必要手続き一覧の作成（Excel、チェックリスト形式）
- 費用見積の作成（官庁手数料、船級費用、代理店費用等をExcel算出）
- 船主への提案書提出（Word/PPT）→承認待ち
- スケジュール策定（船の入渠・寄港予定と調整）

### 2. 旧旗国での抹消手続き（海事業務担当）
- 旧旗国の海事局・領事館への抹消申請書作成（各国所定様式）
- 必要書類の収集（船舶国籍証書原本、売買契約書、抵当権関連書類等）
- 抵当権者の同意書取得（銀行・金融機関にメールで依頼→法的書類の取り交わし）
- 旧旗国代理店への書類送付（国際宅配便）
- 申請・手続きのフォロー（代理店経由で官庁とやり取り、メール/電話）
- 抹消証明書（Deletion Certificate）の受領
- 旧証書類の回収・返却

### 3. 新旗国での登録手続き（海事業務担当）
- 新旗国の登録要件の最終確認
- 仮登録（Provisional Registration）申請書の作成
- 船名予約（新旗国での船名重複確認）
- 必要書類の準備（船舶明細、トン数証書、抹消証明書等）
- 新旗国の海事局・領事館への申請（窓口持参/郵送/代理店経由）
- 仮国籍証書の受領
- 本登録手続き（仮登録から一定期間内に本登録）
- 本登録証書の受領

### 4. 船級関連手続き（海事業務担当）
- 船級協会の変更が伴う場合：新船級への転級手続き
- 転級検査の手配（新船級の検査員派遣依頼）
- 船級証書の発行手続き
- 船級が変わらない場合：旗国変更の通知・証書更新
- ISM/ISPS関連証書の更新手配

### 5. 証書一括更新（海事業務担当）
- 新旗国基準での証書リスト作成（船1隻あたり30〜50種）
- 各証書の新規申請・書き換え手続き
- 検査機関との日程調整（船の寄港に合わせる）
- 必要な検査の実施・立会い
- 新証書の受領・内容確認
- 船への証書送付

### 6. 完了・記録（海事業務担当）
- 船籍変更完了報告書の作成（Word）
- 船主・船舶管理会社への報告（メール + 報告書PDF送付）
- 証書管理台帳の全面更新（Excel、新証書情報を入力）
- 費用精算（実費の集計、船主への請求書作成）
- 案件ファイルの保管（紙ファイル + 共有フォルダ）
- ナレッジの蓄積（特殊ケースの経験則をメモ、属人的に保管）

## 現在の課題
- 旗国ごとに要件が異なり、法令調査に時間がかかる（属人的知識に依存）
- 複数の官庁・機関との並行手続きの進捗管理が煩雑（Excelチェックリスト）
- 海外代理店との時差・言語の壁でコミュニケーションに遅延
- 証書の種類が多く、漏れなく更新するための管理が大変
- 過去案件のナレッジが個人のPCに散在し、組織知化されていない
- 費用見積の精度が経験頼みで、新人では対応困難`,
  },
  {
    name: "日報作成フロー",
    department: "全社",
    content: `# 日報作成フロー

## 概要
各部門の従業員が業務内容を記録・報告する日報の作成・提出・確認プロセス。陸上職はメール or Excel、海上職は航海日誌＋業務日報。管理職は部門日報を集約して週報・月報を作成。

## 業務ステップ

### 1. 日報記入（各従業員）
- 業務終了時に日報を作成（Excel or メール本文、部門によりフォーマットが異なる）
- 陸上職：当日の業務内容、成果、翌日の予定を記入
- 海上職：航海日誌の記入（法定記録、船長・航海士が手書き）
- 海上職：業務日報の記入（機関日誌、荷役記録等、紙ベース）
- 外出・出張中は帰社後にまとめて記入（忘れがち）
- プロジェクト番号・工数の記入（任意だが実態は未記入が多い）

### 2. 日報提出（各従業員→上長）
- 陸上職：メールで上長に送信（CCに部門メーリングリスト）
- 一部部門：共有フォルダのExcelファイルに追記（ファイルロック問題あり）
- 海上職：衛星メールで本社に日報送信（通信コストの都合で簡潔に）
- 提出時刻：業務終了後〜翌朝（バラつきあり）

### 3. 上長確認・フィードバック（管理職）
- 部下の日報を確認（メール or Excelを個別に開いて確認）
- 問題点や気になる事項があればコメント返信（メール）
- 業務量・進捗の把握（日報を読んで頭の中で状況整理）
- 未提出者への催促（口頭 or メール）

### 4. 週報・月報集約（管理職）
- 週次：部下の日報からトピックを拾って週報作成（Word or PPT）
- 部門長への週次報告（メール or 定例会議）
- 月次：月間の業務実績・成果をまとめて月報作成（Excel/PPT）
- 月報を人事部・経営企画部に提出（メール）

### 5. 日報データの活用（人事部・経営企画部）
- 残業時間の傾向分析（日報の記入時刻から推定、不正確）
- プロジェクトごとの工数集計（日報に記載があれば手動集計）
- 部門間の業務量バランス確認（月報ベースで定性的に把握）

## 現在の課題
- 日報フォーマットが部門ごとにバラバラ（Excel, メール, 紙, 衛星メール）
- 提出率が低い部門がある（催促の手間）
- 上長の確認が形骸化しがち（忙しくて読めない）
- 日報→週報→月報の集約が手動コピペで非効率
- 工数データが取れず、プロジェクト原価管理に活用できない
- 海上職の日報が紙ベースで本社でのデータ活用が困難
- 過去の日報検索ができない（メール検索 or フォルダ目視探索）`,
  },
];

async function createProject(wf) {
  const projRes = await fetch(`${BASE}/api/bottleneck/project`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name: wf.name, department: wf.department }),
  });
  const projData = await projRes.json();
  const projectId = projData.project?.id;
  if (!projectId) {
    console.error(`Failed to create project: ${wf.name}`, projData);
    return null;
  }
  console.log(`Created: ${wf.name} -> ${projectId}`);

  const formData = new FormData();
  const blob = new Blob([wf.content], { type: "text/plain" });
  const filename = wf.name.replace(/[・／ ]/g, "_") + ".txt";
  formData.append("file", blob, filename);
  formData.append("projectId", projectId);

  const uploadRes = await fetch(`${BASE}/api/bottleneck/upload`, {
    method: "POST",
    body: formData,
  });
  const uploadData = await uploadRes.json();
  console.log(`  Uploaded: ${uploadData.document?.id || "FAIL"}`);
  return projectId;
}

async function analyzeAndWait(projectId, name) {
  console.log(`\nAnalyzing: ${name}`);
  const res = await fetch(`${BASE}/api/bottleneck/analyze`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ projectId }),
  });
  const data = await res.json();
  if (data.error) { console.log(`  Error: ${data.error}`); return false; }

  for (let i = 0; i < 60; i++) {
    await new Promise(r => setTimeout(r, 5000));
    const s = await (await fetch(`${BASE}/api/bottleneck/analyze?projectId=${projectId}`)).json();
    if (s.status === "completed") { console.log(`  DONE`); return true; }
    if (s.status === "failed") { console.log(`  FAILED: ${s.error}`); return false; }
    if (i % 4 === 0) console.log(`  ...${s.status} (${s.progress}%)`);
  }
  return false;
}

async function main() {
  console.log(`=== Creating ${workflows.length} projects ===\n`);
  const projects = [];
  for (const wf of workflows) {
    const pid = await createProject(wf);
    if (pid) projects.push({ id: pid, name: wf.name });
  }

  console.log(`\n=== Analyzing ${projects.length} projects ===`);
  for (const proj of projects) {
    const ok = await analyzeAndWait(proj.id, proj.name);
    if (!ok) {
      console.log(`  Retrying...`);
      await analyzeAndWait(proj.id, proj.name);
    }
  }
  console.log("\n=== ALL DONE ===");
}

main().catch(console.error);
