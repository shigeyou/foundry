// 商船三井マリテックスの主要業務フローを一括作成するスクリプト
const BASE = "http://localhost:3006";

const workflows = [
  {
    name: "船員配乗・交代管理フロー",
    department: "海事人材部",
    content: `# 船員配乗・交代管理フロー

## 概要
商船三井グループの船舶に配乗する船員の交代・配置管理業務。年間数百件の交代を処理する。

## 業務ステップ

### 1. 交代計画立案（海事人材部・配乗担当）
- 各船の乗船期間（通常6〜9ヶ月）を確認し、交代予定日を算出
- 船員の資格・経験・適性・希望を照合
- Excel一覧で管理、手動で候補者リストを作成
- 配乗計画を部門長に回覧（メールベース）

### 2. 船員への内示・意向確認（配乗担当→船員）
- 電話またはメールで次の配乗先を内示
- 船員から承諾/辞退の回答を受領（口頭→紙の確認書）
- 辞退の場合は代替候補者の再選定（1からやり直し）

### 3. 渡航手続き（海事人材部・渡航担当）
- パスポート有効期限確認（手動でExcel台帳照合）
- ビザ申請が必要な国の場合は外部業者に依頼
- 航空券の手配（旅行代理店にFAXまたはメールで依頼）
- 海外での交代地の場合、現地エージェントとの調整（メール/電話）

### 4. 乗船前訓練・資格確認（訓練部門）
- STCW条約に基づく必須訓練の受講状況を確認
- 期限切れの訓練がある場合は受講を手配
- 訓練修了証の原本コピーを収集・ファイリング
- 健康診断書の有効期限確認（紙ベース管理）

### 5. 書類作成・官庁届出（海事手続担当）
- 雇入届の作成（手書きフォーム + 窓口提出）
- 船員手帳への記載事項変更
- 外国籍船の場合はFlag Stateへの通知
- 船主（オーナー）への配乗通知書の送付（メール）

### 6. 交代実施・引継ぎ（現場）
- 交代港での乗下船手配
- 前任者から後任者への業務引継ぎ（口頭 + 紙の引継書）
- 船長へ着任報告（無線/衛星電話）
- 交代完了報告を本社へ送信（メール）

### 7. 下船後処理（海事人材部 + 経理部）
- 雇止届の作成・提出
- 下船者の給与精算（航海日数×日額の計算、Excel）
- 残有給休暇の計算・付与
- 次回配乗までの待機期間管理

## 現在の課題
- 船員情報がExcel複数ファイルに分散、最新版が不明確
- 資格・訓練の期限管理が人の記憶頼り
- 渡航手配のFAX依存、確認の往復に時間がかかる
- 交代計画の変更（急病、天候、港湾事情）で全体が玉突き的に影響
- 下船後の給与精算に2週間以上かかることがある`,
  },
  {
    name: "新造船検査・引渡しフロー",
    department: "新造船マネジメント事業本部",
    content: `# 新造船検査・引渡しフロー

## 概要
商船三井グループや外部船主向けの新造船の建造監督・検査・引渡しまでの業務フロー。造船所での建造監督から竣工・引渡しまで、通常2〜3年のプロジェクト。

## 業務ステップ

### 1. 建造仕様書レビュー（技術部門）
- 船主から受領した建造仕様書の技術レビュー
- 造船所の図面との整合性確認（紙図面 + PDF）
- コメントリストをExcelで作成し、船主・造船所に送付
- 複数回の往復修正（メールベース、バージョン管理が煩雑）

### 2. 造船所巡回検査（検査員）
- 週次・月次の進捗検査（現地立会い）
- 検査チェックリスト（紙フォーム）に手書きで記録
- 写真撮影→PCに取り込み→報告書に貼付（手動）
- 不適合事項の記録・追跡（Excelリスト）
- 造船所への是正要求書の発行（メール + FAX）

### 3. 機器・設備の試験立会い（技術担当）
- 主機関・補機・航海機器等の工場試験（FAT）立会い
- 試験成績書の受領・確認（紙の原本が必須）
- 不合格時の再試験スケジュール調整
- 合格書類のファイリング（キャビネット保管）

### 4. 海上公試運転（プロジェクトチーム）
- 試験航海のスケジュール調整（造船所・船級・船主の三者）
- 速力試験、操舵試験、非常停止試験等の実施
- 計測データの記録（手書き→後日Excel入力）
- 試験結果の速報を船主に報告（メール）

### 5. 船級検査・旗国検査対応（船級担当）
- 船級協会（NK, LR, DNV等）の検査員への対応
- 検査指摘事項の造船所への伝達・フォロー
- 証書発行手続き（船級証書、安全設備証書等）
- 旗国当局への登録手続き書類準備

### 6. 引渡し書類整備（管理部門）
- 引渡し書類リスト（通常300〜500件）の作成・管理
- 各書類の受領チェック（紙台帳で管理）
- 未受領書類の造船所への督促（メール/電話）
- 最終書類セットの印刷・製本（数十部）

### 7. 引渡し・竣工（プロジェクトリーダー）
- 引渡し式典の段取り
- 議定書（Protocol of Delivery and Acceptance）への署名
- 残工事リスト（Punch List）の合意・フォロー
- プロジェクト完了報告書の作成（Word、30〜50ページ）
- 経験・教訓の社内共有（共有フォルダにPDF保存のみ）

## 現在の課題
- 不適合事項・Punch Listの追跡がExcel依存で属人化
- 写真管理が個人PC依存、検索性ゼロ
- 引渡し書類300件以上の進捗管理が手動台帳
- 造船所とのコメント往復がメールで埋もれやすい
- プロジェクト完了後のナレッジ共有が形骸化`,
  },
  {
    name: "操船シミュレータ訓練運営フロー",
    department: "海技訓練部",
    content: `# 操船シミュレータ訓練運営フロー

## 概要
船員向けの操船シミュレータを使った訓練プログラムの企画・実施・評価の業務フロー。STCW条約に基づく法定訓練と、船主要望のカスタム訓練を提供。

## 業務ステップ

### 1. 訓練申込受付（営業・窓口）
- 船主・船舶管理会社からの訓練依頼を受付（メール/電話/FAX）
- 訓練内容・日程・参加人数のヒアリング
- 空き状況をシミュレータ予約台帳（Excel）で確認
- 見積書の作成・送付（Word/Excelテンプレート）
- 船主からの発注書受領（メール/FAXの紙）

### 2. 訓練シナリオ準備（インストラクター）
- 船種・航路に合わせたシナリオ作成（専用ソフト）
- 気象・海象条件の設定
- 港湾データベースの更新が必要な場合は外部ベンダーに依頼
- 訓練教材（紙テキスト）の印刷・準備
- リハーサル実施（インストラクター間で確認）

### 3. 受講者管理（事務局）
- 受講者リストの受領・登録（Excel台帳）
- 受講者の資格証明書コピーの収集（メール/紙）
- 宿泊手配（必要な場合、近隣ホテルに電話予約）
- 受講案内の送付（メール + 紙の案内状）
- 受講料の請求書発行（経理システムに手入力）

### 4. 訓練実施（インストラクター + 技術スタッフ）
- シミュレータ機器の起動・動作確認（毎朝30分）
- 座学講義の実施（PowerPoint + 配布資料）
- シミュレータ実習の運用・モニタリング
- 訓練中の評価記録（紙の評価シートに手書き）
- 機器トラブル時の対応（技術スタッフが手動復旧）

### 5. 評価・修了処理（インストラクター + 事務局）
- 訓練評価シートの集計（手書き→Excel入力）
- 合否判定（インストラクター間で協議）
- 不合格者への再訓練日程調整
- 修了証書の作成（Wordテンプレート、1枚ずつ名前差替え）
- 修了証書の印刷・押印・郵送

### 6. 報告・請求（事務局 + 経理）
- 訓練実施報告書の作成（Word）
- 船主への報告書送付
- 訓練実績の社内データベース登録（Access）
- 請求処理（経理に紙の請求依頼書を回覧）
- 入金確認・消込（経理部が手動確認）

## 現在の課題
- シミュレータ予約がExcel台帳でダブルブッキングのリスクあり
- 修了証書の1枚ずつ手作業が非効率（年間数百枚）
- 受講者の資格・訓練履歴が分散管理
- 訓練評価が紙ベースでデータ分析不可能
- 請求・入金管理が手動で漏れが発生`,
  },
  {
    name: "船舶メンテナンス・入渠管理フロー",
    department: "オンサイト事業部",
    content: `# 船舶メンテナンス・入渠（ドック入り）管理フロー

## 概要
運航中の船舶の定期メンテナンスおよびドック入り（入渠）の計画・実施・完了管理。通常2.5年ごとの中間検査、5年ごとの定期検査に対応。

## 業務ステップ

### 1. メンテナンス計画策定（テクニカルマネージャー）
- 船級協会の検査スケジュールを確認（船級Webポータル）
- 過去の修繕履歴をExcelから参照
- 船長からの修繕要望リスト受領（衛星メール）
- メンテナンス項目の優先順位付け（テクニカルミーティングで協議）
- 概算予算の作成（過去実績ベース、Excelで積算）

### 2. 造船所・修繕ドック選定（調達担当）
- 候補ドックへ仕様書を送付し見積依頼（メール）
- 見積回答の収集（通常3〜5社、2〜3週間待ち）
- 比較表の作成（Excel）
- 船主への見積提示・承認取得（メール回覧）
- ドック予約確定（契約書なし、メールでの合意のみの場合あり）

### 3. 入渠準備（テクニカルチーム）
- 修繕仕様書（Repair Specification）の作成（Word、100〜200項目）
- 資機材・予備品の手配（サプライヤーにメール/FAXで発注）
- 納期確認・ドック入り日程との調整
- 船級検査員の手配申請（船級協会Webポータル + メール）
- 監督員の出張手配（旅行代理店にメール）

### 4. 入渠中の工事管理（現場監督）
- 毎日の作業進捗確認（現場巡回 + 写真撮影）
- 追加修繕の発見・見積取得・船主承認（メールで都度やりとり）
- 日報の作成（Word/Excel→メールで本社に送信）
- 船級検査の立会い・指摘事項フォロー
- 安全管理（作業許可書の確認、紙ベース）

### 5. 工事完了・出渠（テクニカルマネージャー + 経理）
- 最終検査・確認（チェックリスト、紙に署名）
- 残工事の有無確認・合意
- 造船所からの最終請求書受領
- 請求内容の査定（仕様書との照合、手動）
- 支払承認→経理部へ処理依頼（紙の稟議書）
- 入渠完了報告書の作成（Word、20〜30ページ）

### 6. 実績管理・分析（管理部門）
- 入渠コストの実績登録（Excelの年間台帳）
- 予算対実績の差異分析
- 船主への実績報告書送付
- 次回入渠に向けた改善メモ作成（個人ファイルに保存）

## 現在の課題
- 修繕履歴がExcelファイル複数に分散、船ごとの一元管理ができていない
- 入渠中の追加工事承認がメール往復で遅延→工期超過の原因
- 写真データが個人PC/メールに分散、後から検索困難
- 見積比較が手動で時間がかかる
- 入渠コストの予実管理がリアルタイムでない`,
  },
  {
    name: "海事コンサルティング案件管理フロー",
    department: "コンサルティング部",
    content: `# 海事コンサルティング案件管理フロー

## 概要
官公庁・港湾事業者・エネルギー企業等への海事コンサルティングサービスの案件受注から納品・請求までの業務フロー。

## 業務ステップ

### 1. 案件引合い・提案（営業 + コンサルタント）
- 顧客からの問い合わせ受付（電話/メール/紹介）
- ヒアリング実施（対面/Web会議）→議事録作成（Word）
- 類似案件の過去実績を検索（共有フォルダを目視検索）
- 提案書の作成（PowerPoint、チームで分担作成）
- 見積書の作成（Excel）→部門長承認（メール回覧）→顧客提出

### 2. 受注・契約（営業 + 管理部門）
- 顧客からの発注書/内示書の受領
- 契約書の作成（Word、過去テンプレートを流用）
- 法務チェック（メールで法務担当に転送、回答待ち）
- 契約書の製本・押印（紙原本2部、郵送で往復）
- 案件番号の採番・社内登録（Excelの案件台帳）

### 3. プロジェクト実行（コンサルタントチーム）
- キックオフミーティング実施
- 現地調査・データ収集（出張対応）
- シミュレーション実行（専用ソフト）
- 中間報告書の作成（Word/PowerPoint）
- 顧客との中間レビュー会議
- 最終報告書の作成（Word、50〜200ページ）
- 社内品質レビュー（部門長 + ベテランがPDFに赤入れ）

### 4. 納品・検収（プロジェクトリーダー）
- 最終報告書の印刷・製本（外注印刷の場合あり）
- 顧客への納品（郵送 or 対面手渡し + 電子データ）
- 検収書の受領（紙に押印、返送待ちで1〜2週間）
- 成果物の社内アーカイブ（共有フォルダにPDF保存）

### 5. 請求・入金管理（管理部門 + 経理）
- 請求書の作成（Excelテンプレート）
- 部門長承認→経理部に回付（紙の回覧）
- 請求書の印刷・押印・郵送（紙原本）
- 入金確認（経理が銀行口座を毎日目視確認）
- 消込処理（経理が手動で案件番号と突合）
- 未入金の場合は営業に督促依頼

### 6. 案件完了・ナレッジ蓄積
- プロジェクト完了報告（部門会議で口頭報告）
- 案件実績の更新（Excel台帳）
- 教訓・改善点のメモ（個人ノート、共有されない場合が多い）

## 現在の課題
- 案件台帳がExcelで同時編集できず最新版が不明
- 過去の類似案件検索が共有フォルダの目視探索で非効率
- 契約書の押印・郵送に2〜3週間かかる
- 品質レビューがPDF赤入れ→修正→再レビューで回数が多い
- 案件別の収支管理がリアルタイムでできない
- 完了後のナレッジが属人化して蓄積されない`,
  },
  {
    name: "安全管理・事故対応フロー",
    department: "安全管理部",
    content: `# 安全管理・事故対応フロー（ISMコード準拠）

## 概要
ISMコード（国際安全管理コード）に基づく安全管理体制の運用と、海上事故・インシデント発生時の対応フロー。

## 業務ステップ

### 1. 日常安全管理（DPA/安全管理責任者）
- 各船からの安全報告書の受領・確認（衛星メール/船社システム）
- ニアミス・ヒヤリハット報告の収集（月次、紙フォーム→Excel集計）
- 安全KPIの集計（事故件数、PSC指摘数など、Excelで手動集計）
- 安全委員会資料の作成（PowerPoint、毎月）
- ISM内部監査の計画・実施（年次、紙のチェックリスト）

### 2. 事故・インシデント発生時の初動対応（当直者→DPA）
- 船長からの第一報受信（衛星電話/メール）
- 事故概要の記録（手書きメモ→後日Word入力）
- 緊急連絡網の発動（電話リレー、紙の連絡網を参照）
- 船主・P&Iクラブ（保険）への第一報（電話 + メール）
- 関係当局（海上保安庁、Flag State）への報告書提出（所定様式に手書き/入力）

### 3. 事故調査（調査チーム）
- 調査チームの編成・派遣
- 現場調査・証拠収集（写真、航海記録、VDRデータ）
- 乗組員からの聞き取り調査（対面、記録は手書き→Word入力）
- 時系列の整理（Excel/Wordで手動作成）
- 根本原因分析（RCA）の実施（ホワイトボード→写真撮影）

### 4. 報告書作成・提出（調査リーダー + 法務）
- 事故調査報告書の作成（Word、テンプレートあり）
- 社内レビュー（DPA + 法務 + 経営層、メール回覧）
- 船級協会への報告書提出
- 旗国当局への報告書提出（所定様式）
- P&Iクラブへの損害報告・クレーム書類作成

### 5. 是正措置・再発防止（安全管理部 + 関係部門）
- 是正措置計画の策定（Excel）
- 関係部門への是正措置指示（メール）
- 実施状況のフォローアップ（メール催促、Excel台帳で管理）
- 安全通達（Fleet Circular）の発行（Word→PDF→全船にメール配信）
- 効果検証の実施（次回監査時に確認）

### 6. 記録管理・統計（安全管理部）
- 事故・インシデントデータベースの更新（AccessまたはExcel）
- 年次安全統計レポートの作成
- 船主への安全実績報告（PowerPoint）
- 外部監査（ISM、船級）対応の記録準備
- 安全教育カリキュラムへの反映（訓練部門に口頭で依頼）

## 現在の課題
- 事故発生時の連絡がアナログ（電話リレー）で伝達遅延・伝達漏れ
- ヒヤリハット報告が紙→Excel転記で分析に時間がかかる
- 是正措置の進捗管理がメール催促頼みで形骸化しやすい
- 事故データベースが独自Excelで横断分析が困難
- RCA（根本原因分析）の結果が社内共有されにくい
- 安全統計の集計が毎月手作業で半日以上かかる`,
  },
  {
    name: "購買・調達管理フロー",
    department: "管理部",
    content: `# 購買・調達管理フロー

## 概要
船舶用資機材・予備品・消耗品の調達、およびオフィス関連の購買業務フロー。船舶用品は世界各地の港で納入する必要があり、物流が複雑。

## 業務ステップ

### 1. 購買要求（各部門 / 船舶）
- 船舶：船長が必要物品リストを作成（専用フォーム or Excel）→衛星メールで送信
- 陸上部門：購買依頼書（紙フォーム）を作成→上長承認（押印）→購買部門へ回覧
- 緊急購買：電話で口頭依頼→後追いで書類作成
- 購買部門で依頼内容を確認・仕様を明確化

### 2. サプライヤー選定・見積取得（調達担当）
- 承認サプライヤーリスト（Excel）から候補を選定
- 見積依頼書の送付（メール、3社以上が原則）
- 見積回答の受領・比較表作成（Excel）
- 金額が閾値超の場合は稟議書作成（紙）→複数承認者の回覧（1〜2週間）

### 3. 発注（調達担当）
- 注文書の作成（Excelテンプレート）
- 上長承認（メール or 紙押印）
- サプライヤーへ注文書送付（メール/FAX）
- 納期・納入場所（世界各港）の確認
- 発注台帳への記録（Excel）

### 4. 納品・検収（現場 / 船舶）
- 船舶向け：指定港での船積み手配（船舶代理店に依頼、メール）
- 陸上向け：オフィスでの受取り
- 納品書との照合（手動、紙ベース）
- 不良品・数量不足の場合はサプライヤーにクレーム（メール）
- 検収完了の報告（メールで購買部門に通知）

### 5. 支払処理（経理部）
- サプライヤーからの請求書受領（郵送 or メール）
- 注文書・納品書・請求書の三点照合（手動、紙ベース）
- 支払承認（紙の回覧→押印）
- 銀行振込処理（経理システムに手入力）
- 外貨建ての場合は為替レート確認・換算

### 6. 在庫管理・分析（管理部門）
- 船舶用予備品の在庫台帳更新（Excel、船ごとに別ファイル）
- 発注実績の集計・分析（四半期ごと、Excel）
- サプライヤー評価（年次、手動でデータ収集）
- 予算対実績の管理

## 現在の課題
- 船舶からの購買要求が衛星メール＋紙混在で見落としリスク
- 稟議書の回覧に1〜2週間かかり、緊急発注に対応できない
- 三点照合が完全手動で照合ミスが発生
- 船舶在庫の把握がリアルタイムでない
- サプライヤー評価が属人的で標準化されていない
- 外貨建て取引の為替リスク管理が不十分`,
  },
];

async function createProject(wf) {
  // 1. Create project
  const projRes = await fetch(`${BASE}/api/bottleneck/project`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name: wf.name, department: wf.department }),
  });
  const projData = await projRes.json();
  const projectId = projData.project?.id;
  if (!projectId) {
    console.error(`Failed to create project: ${wf.name}`, projData);
    return null;
  }
  console.log(`Created project: ${wf.name} -> ${projectId}`);

  // 2. Upload document
  const formData = new FormData();
  const blob = new Blob([wf.content], { type: "text/plain" });
  const filename = wf.name.replace(/[・／]/g, "_") + ".txt";
  formData.append("file", blob, filename);
  formData.append("projectId", projectId);

  const uploadRes = await fetch(`${BASE}/api/bottleneck/upload`, {
    method: "POST",
    body: formData,
  });
  const uploadData = await uploadRes.json();
  console.log(`  Uploaded: ${filename} -> ${uploadData.document?.id || "FAIL"}`);

  return projectId;
}

async function startAnalysis(projectId, name) {
  const res = await fetch(`${BASE}/api/bottleneck/analyze`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ projectId }),
  });
  const data = await res.json();
  console.log(`  Analysis started: ${name} -> ${data.message || data.error}`);
  return projectId;
}

async function waitForCompletion(projectId, name) {
  const maxWait = 180; // 3 minutes max per project
  for (let i = 0; i < maxWait; i++) {
    await new Promise((r) => setTimeout(r, 5000));
    const res = await fetch(`${BASE}/api/bottleneck/analyze?projectId=${projectId}`);
    const data = await res.json();
    if (data.status === "completed") {
      console.log(`  Completed: ${name}`);
      return true;
    }
    if (data.status === "failed") {
      console.error(`  FAILED: ${name} - ${data.error}`);
      return false;
    }
    if (i % 6 === 0) {
      console.log(`  ...${name}: ${data.status} (${data.progress}%)`);
    }
  }
  console.error(`  TIMEOUT: ${name}`);
  return false;
}

async function main() {
  console.log(`=== Creating ${workflows.length} workflow projects ===\n`);

  // Create all projects and upload documents
  const projects = [];
  for (const wf of workflows) {
    const pid = await createProject(wf);
    if (pid) projects.push({ id: pid, name: wf.name });
  }

  console.log(`\n=== Starting analysis for ${projects.length} projects (sequential) ===\n`);

  // Run analysis sequentially (AI calls are heavy)
  for (const proj of projects) {
    await startAnalysis(proj.id, proj.name);
    const ok = await waitForCompletion(proj.id, proj.name);
    if (!ok) {
      console.log(`  Retrying: ${proj.name}`);
      await startAnalysis(proj.id, proj.name);
      await waitForCompletion(proj.id, proj.name);
    }
    console.log("");
  }

  console.log("=== ALL DONE ===");
}

main().catch(console.error);
