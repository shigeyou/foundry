const BASE = "http://localhost:3006";

const workflows = [
  {
    name: "採用管理フロー",
    department: "人事部",
    content: `# 採用管理フロー

## 概要
新卒・中途・契約社員の採用業務。海事専門職（船員、技術員、コンサルタント等）の採用は特殊資格が必要で選考が複雑。

## 業務ステップ

### 1. 採用計画・求人作成（人事部 + 各部門）
- 各部門から人員補充要望を収集（メール/会議での口頭依頼）
- 要望を人員計画表（Excel）に集約し、経営層承認を取得（稟議書・紙回覧）
- 求人票の作成（Wordテンプレート）→部門長確認→人事部長承認（メール）
- 求人媒体への掲載手配（各媒体の管理画面に個別ログインして入力）
- 人材紹介会社への求人情報送付（メール + PDF）

### 2. 応募受付・書類選考（人事部）
- 応募書類の受領（メール添付 / 紙郵送 / 媒体経由）
- 応募者情報をExcel台帳に手入力（媒体ごとにフォーマットが異なる）
- 書類選考（人事担当が部門長にメールで履歴書転送→判定回答待ち）
- 合否結果を応募者にメール連絡（テンプレートをコピペして個別送信）
- 不合格者データの保管（個人情報管理、Excelで管理期限設定）

### 3. 面接調整・実施（人事部 + 面接官）
- 面接日程の調整（応募者・面接官双方にメールで候補日を打診→往復）
- 会議室予約（社内予約システム or 口頭確認）
- 面接官への応募者資料の事前共有（メール添付）
- 面接実施（対面 or Web）→面接評価シート記入（紙 or Excel）
- 評価シートの回収・集約（メールで催促、Excelに転記）

### 4. 内定・条件提示（人事部 + 部門長 + 経営層）
- 採用可否の判定会議（対面、議事録はWord）
- 給与・条件の算定（給与テーブルExcel参照、前職考慮）
- 経営層の最終承認（稟議書、紙に押印回覧）
- 内定通知書の作成（Wordテンプレート）→印刷・押印・郵送
- 応募者からの内定承諾/辞退の回答受領（電話/メール）
- 辞退時は次点候補者への繰上げ連絡

### 5. 入社手続き準備（人事部 + 総務）
- 雇用契約書の作成（Wordテンプレート、個別修正）→印刷・押印・2部郵送
- 入社前提出書類の案内（年金手帳、住民票等のリストをメール送付）
- 提出書類の受領・確認チェック（紙で受領、チェックリストに手書き）
- PC・備品・IDカードの手配（総務にメールで依頼）
- 社内アカウント作成依頼（IT部門にメール）

### 6. 採用実績管理・分析（人事部）
- 採用コスト集計（媒体費用、紹介料等をExcelで手動集計）
- 採用チャネル別の実績分析（応募数、内定率等、四半期ごとにExcel作成）
- 経営層への採用状況報告（PowerPoint）

## 現在の課題
- 応募者管理がExcelで、複数担当者の同時更新ができない
- 面接日程調整がメール往復で1週間以上かかることがある
- 求人媒体ごとに管理画面が異なり、一元管理不可
- 面接評価の回収が遅れ、選考スピードが競合に劣る
- 内定通知〜契約書が紙ベースで郵送往復に2〜3週間
- 採用データの分析が手動で、傾向把握が遅い`,
  },
  {
    name: "新入社員オンボーディングフロー",
    department: "人事部",
    content: `# 新入社員オンボーディングフロー

## 概要
入社日から独り立ちまでの受入れ・教育・フォローアップの業務フロー。陸上職と海上職で内容が異なる。

## 業務ステップ

### 1. 入社日準備（人事部 + 総務 + IT）
- 座席・ロッカーの割り当て（総務が空き状況を目視確認）
- PC・携帯電話・IDカードの準備（IT部門がセットアップ、1台ずつ手動）
- メールアカウント・システム権限の設定（IT部門に紙の申請書を提出）
- 名刺の発注（外注印刷会社にFAX/メール）
- 入社式・オリエンテーションのスケジュール作成（Excel）
- 配属部門への受入れ連絡（メール）

### 2. 入社日当日（人事部）
- 受付・案内（人事担当が出迎え）
- 入社書類の最終確認・回収（紙の提出物チェック）
- 社員証の写真撮影・発行
- 就業規則・社内規程の説明（紙の冊子を配布、1時間の説明会）
- 各種届出用紙の記入（通勤経路届、口座届、扶養届等、すべて紙）
- 社会保険・雇用保険の届出書類作成（人事が手書き/入力、ハローワーク等に提出）

### 3. 初期研修（人事部 + 各部門）
- 全社研修（会社概要、安全管理、コンプライアンス）：1〜3日、座学
- 部門別研修スケジュールの調整（部門の教育担当とメールで日程調整）
- OJTトレーナーの指名（部門長がメールで指名）
- 研修資料の準備・印刷（PowerPoint→PDF→紙配布）
- eラーニング受講（あれば）のアカウント発行

### 4. 配属・OJT（配属部門）
- トレーナーによるOJT計画作成（Excel or Word、フォーマットは部門ごとにバラバラ）
- 日次/週次の業務指導（口頭ベース）
- OJT進捗の記録（紙のチェックシート or なし）
- 1ヶ月面談の実施（トレーナー + 上長、議事録はWordまたは口頭のみ）

### 5. フォローアップ（人事部 + 配属部門）
- 3ヶ月面談の実施（人事 + 上長、紙の面談シート）
- 試用期間終了の評価（評価シートを部門長が記入→人事にメール送付）
- 正式採用の決裁（稟議書、紙回覧）
- 6ヶ月・1年フォローアップ面談
- 新人アンケートの実施（紙配布→回収→Excel集計）

### 6. 記録・改善（人事部）
- オンボーディング実施記録の保管（紙ファイル + 一部Excel）
- 離職率・定着率の分析（年次、Excel手動集計）
- オンボーディングプログラムの改善検討（年1回の会議で議論）

## 現在の課題
- 入社書類が全て紙で、記入漏れ・不備の手戻りが多い
- 社会保険手続きの書類作成が手作業で時間がかかる
- OJT計画・進捗が部門ごとにバラバラで品質にムラ
- 研修スケジュール調整がメール往復で煩雑
- 新人の状況を人事がリアルタイムに把握できない
- フォローアップ面談の実施漏れが発生しがち`,
  },
  {
    name: "退職者手じまいフロー",
    department: "人事部",
    content: `# 退職者手じまいフロー

## 概要
退職申出から最終出社日・退職手続き完了までの業務フロー。船員の退職は乗船スケジュールとの調整が必要で複雑。

## 業務ステップ

### 1. 退職申出・受理（本人→上長→人事部）
- 本人が上長に退職意思を伝達（口頭 or メール）
- 上長が慰留面談を実施
- 退職届の受領（紙の所定様式に手書き、押印）
- 人事部への報告（上長からメールで連絡、退職届のスキャンPDF添付）
- 退職日・最終出社日の確定
- 退職理由のヒアリング（人事が面談、記録は紙のメモ）

### 2. 引継ぎ計画（退職者 + 上長 + 後任者）
- 引継ぎ計画書の作成（退職者がWord/Excelで作成、フォーマットなし）
- 担当業務の棚卸し（口頭 + リスト作成）
- 後任者への引継ぎ実施（OJT形式、1〜4週間）
- 顧客・取引先への担当変更連絡（メールを1件ずつ送信）
- 引継ぎ完了確認（上長が口頭で確認、書面化されないことが多い）

### 3. 各部門への返却・停止依頼（人事部 + 総務 + IT）
- PCの初期化・返却（IT部門にメールで依頼→退職日に実施）
- IDカード・鍵の返却（総務に対面で返却）
- メールアカウント・システム権限の停止依頼（IT部門にメール）
- 社用携帯の返却・解約手続き
- 名刺の回収（残部があれば）
- 社内メーリングリストからの削除（IT部門に依頼）

### 4. 退職手続き（人事部 + 経理部）
- 退職証明書の作成（Wordテンプレート）→押印→郵送
- 離職票の作成・ハローワーク提出（手書きまたは電子申請）
- 社会保険の資格喪失届（年金事務所・健保組合に書類提出）
- 住民税の特別徴収→普通徴収切替届（市区町村に郵送）
- 最終給与計算（日割計算、未消化有給の精算、Excel）
- 退職金計算（該当者、規程に基づきExcelで算出）→経営層承認（稟議書）

### 5. 最終精算・送付（経理部 + 人事部）
- 最終給与の振込処理
- 源泉徴収票の作成・郵送
- 退職所得の受給に関する申告書の回収（紙）
- 健康保険証の回収（郵送で返却してもらう、届かない場合は催促）
- 企業年金・確定拠出年金の移管手続き案内（書面郵送）

### 6. 退職後対応（人事部）
- 退職者データの更新（Excel台帳を「退職」に変更）
- 退職理由の分析データ蓄積（Excel、年次で集計）
- 退職者情報の保管期間管理（法定保存期間の管理、紙/Excel）

## 現在の課題
- 返却物の漏れが発生（退職後に社用携帯が戻ってこない等）
- 各部門への停止依頼がメールバラバラで漏れやすい
- 離職票の作成が手作業で記入ミスが発生
- 引継ぎの質が属人的で標準化されていない
- 健康保険証の回収が滞ることが多い
- 退職理由の分析が年次のExcel集計で、傾向把握が遅い`,
  },
  {
    name: "支払管理フロー",
    department: "経理部",
    content: `# 支払管理フロー

## 概要
取引先への支払い（外注費、仕入、経費等）の承認から振込実行・消込までの業務フロー。月間数百件の支払を処理。外貨建て取引も多い。

## 業務ステップ

### 1. 請求書受領・登録（経理部）
- 取引先からの請求書受領（郵送 / メール添付PDF / FAX）
- 請求書の開封・仕分け（紙は部門別に仕分け、メールは転送）
- 請求書台帳への登録（Excelに手入力：取引先名、金額、支払期日、通貨）
- 原本の保管（紙をファイリング、部門コード別）

### 2. 内容確認・承認（各部門 + 経理部）
- 請求書を担当部門に回覧（紙を社内便 or スキャンしてメール）
- 担当者が注文書/契約書との照合確認（手動で紙を突き合わせ）
- 部門長の支払承認（紙の請求書に押印 or メールで「OK」返信）
- 経理部に承認済み請求書を返送
- 予算残高の確認（部門別予算管理Excel参照）

### 3. 支払データ作成（経理部）
- 支払一覧表の作成（Excelで集計、支払日別にまとめる）
- 振込先情報の確認（初回取引先は口座情報を手入力登録）
- 外貨建ての場合は為替レート確認・円換算（銀行Webサイトで当日レート確認）
- 支払データの銀行フォーマット変換（全銀フォーマット、専用ソフト or Excel）
- 経理部長の最終承認（紙の支払一覧に押印）

### 4. 振込実行（経理部）
- インターネットバンキングにログイン
- 支払データのアップロード or 手入力
- 承認者によるダブルチェック・振込承認（別担当がIBにログインして承認）
- 振込実行
- 振込結果の確認（翌営業日に通帳記帳 or IB明細確認）

### 5. 消込・記帳（経理部）
- 振込完了の記帳処理（会計システムに仕訳入力）
- 買掛金の消込処理（手動で請求書と振込を突合）
- 支払通知書の送付（取引先にメール、一部はFAX）
- 源泉徴収が必要な支払の税額計算・納付処理

### 6. 月次・期末処理（経理部）
- 未払金の確認・計上（月末に未処理の請求書をExcelでリストアップ）
- 支払実績の部門別集計・報告（Excel）
- 銀行残高との照合（手動で通帳と帳簿を突合）
- 支払関連書類の保管（法定保存7年、紙ファイル + PDF）

## 現在の課題
- 請求書が紙・メール・FAX混在で受領漏れが発生
- 部門への回覧が紙ベースで承認に1〜2週間かかる
- 手動の三点照合（注文書・納品書・請求書）でミスが起きる
- 外貨建て支払の為替リスク管理が不十分
- 振込データの手入力・変換でミスのリスクがある
- 月末の未払計上が請求書の到着遅れで漏れる`,
  },
  {
    name: "会議運営フロー",
    department: "経営企画部",
    content: `# 会議運営フロー

## 概要
取締役会、経営会議、部門長会議等の定例会議および臨時会議の企画・準備・実施・フォローアップの業務フロー。

## 業務ステップ

### 1. 会議計画・日程調整（事務局）
- 年間会議カレンダーの作成（Excel、年初に作成）
- 各回の議題収集（各部門にメールで照会→回答を集約）
- 出席者の日程確認（メールで候補日を打診→調整）
- 会議室の予約（社内システム or 口頭確認）
- Web会議の場合はURL発行（Teams/Zoom手動設定）
- 開催通知の送付（メール）

### 2. 資料準備（事務局 + 各部門）
- 議案書フォーマットの配布（Wordテンプレート、メール添付）
- 各部門が議案書を作成（Word/PowerPoint）→事務局にメール提出
- 提出期限の管理・督促（メールで個別催促）
- 資料の取りまとめ・ページ番号付与（手動でPDF結合）
- 資料の印刷・製本（出席者数分、ホチキス止め）
- 資料の事前配布（メール + 紙を机上配布）

### 3. 会議実施（事務局 + 議長）
- 会場設営（プロジェクター、マイク、座席札の準備）
- 出欠確認（入室時に手動チェック）
- 議事進行のサポート
- 議事録のメモ取り（PCまたは手書き）
- 決議事項の確認・読み上げ

### 4. 議事録作成・承認（事務局）
- 議事録のドラフト作成（Word、会議翌日〜3日後）
- 議長・出席者への確認回覧（メール添付で送付→修正コメント収集）
- 修正反映・最終版確定
- 議事録への押印（取締役会の場合は出席取締役全員、紙原本）
- 議事録の保管（紙原本をキャビネット + PDF を共有フォルダ）

### 5. 決議事項フォローアップ（事務局 + 各部門）
- 決議事項・宿題リストの作成（Excel）
- 担当部門への対応依頼（メール）
- 進捗確認（次回会議前にメールで照会）
- 未対応事項の督促
- 次回会議での進捗報告取りまとめ

### 6. 年次管理（事務局）
- 会議開催実績の記録（Excel台帳）
- 議案・決議の検索用インデックス作成（年度末にExcel作成）
- 議事録原本の長期保管（法定保存期間の管理）

## 現在の課題
- 議題収集・資料催促がメール個別送信で事務局の負荷が大きい
- 資料のPDF結合・印刷が毎回手作業で時間がかかる
- 議事録の確認回覧に1週間以上かかることがある
- 決議事項のフォローアップがExcel台帳で形骸化しやすい
- 過去の議案・決議の検索が困難（共有フォルダの目視探索）
- 取締役会議事録の押印に全員分の日程調整が必要`,
  },
  {
    name: "海事業務部 GC/LC業務フロー",
    department: "海事業務部",
    content: `# 海事業務部 GC/LC業務フロー

## 概要
General Certificate（一般証明書）およびLetter of Compliance（適合証書）に関する海事手続き業務。船舶の登録・証書管理・官庁対応を行う。日本籍船・外国籍船の両方を扱い、国際条約・国内法令に基づく複雑な手続きが必要。

## 業務ステップ

### 1. 証書更新計画（海事業務担当）
- 管理船舶の証書有効期限一覧を確認（Excel台帳、船ごとに数十種の証書）
- 更新が必要な証書のリストアップ（3ヶ月前から準備開始）
- 船主・船舶管理会社への更新案内（メール）
- 更新スケジュールの策定（船の寄港予定との調整が必要）
- 検査機関（JG/船級協会）との日程調整（電話/メール）

### 2. 申請書類準備（海事業務担当）
- 申請に必要な書類リストの確認（証書種類ごとに異なる）
- 申請書の作成（官庁所定様式に手書き or PDF入力）
- 添付書類の収集（船舶国籍証書、測度証書等のコピー）
- 船からの書類取り寄せ（衛星メール/代理店経由で原本スキャン依頼）
- 翻訳が必要な場合は翻訳手配（外部翻訳会社にメール依頼）
- 申請書類一式の最終チェック（ベテラン担当者が目視確認）

### 3. 官庁・検査機関対応（海事業務担当）
- 地方運輸局/JG（日本政府）への申請書提出（窓口持参 or 郵送）
- 船級協会への検査申請（Webポータル + メール）
- 検査日程の最終確認・調整
- 検査員の乗船手配（船の入港スケジュールと合わせる）
- 検査立会い（必要に応じて現地対応）
- 検査指摘事項への対応フォロー

### 4. 証書発行・受領（海事業務担当）
- 証書の発行完了通知受領
- 証書原本の受取り（官庁窓口 or 郵送）
- 証書内容の確認（記載事項に誤りがないか目視チェック）
- 誤りがある場合は再発行申請（書類作り直し）
- 船への証書送付手配（国際宅配便 or 代理店経由）
- 証書コピーの船主への送付（メール添付PDF）

### 5. 台帳管理・記録（海事業務担当）
- 証書管理台帳の更新（Excel、船ごとに1シート）
- 証書原本/コピーのファイリング（紙ファイル、船名別キャビネット）
- 有効期限のリマインダー設定（Outlook予定表に手動登録）
- 国際条約改正への対応（新要件の確認・船主への案内）

### 6. 雇入届・雇止届（船員配乗関連）
- 船員の乗船/下船に伴う雇入届/雇止届の作成（官庁所定様式）
- 船員手帳の記載事項変更
- 地方運輸局への届出（窓口提出 or 電子申請）
- 届出完了の記録・報告（船主/船舶管理会社にメール）

## 現在の課題
- 証書の種類が多く（船1隻あたり30〜50種）、期限管理がExcelだと見落としリスク大
- 官庁様式が紙・手書き前提で、電子申請できるものが限られる
- 船からの書類取り寄せに時間がかかる（衛星通信の遅延）
- 条約改正への対応が属人的（ベテランの知識に依存）
- 証書ファイリングが紙ベースで検索が困難
- 複数の船の手続きが同時進行し、進捗管理が煩雑`,
  },
  {
    name: "給与管理フロー",
    department: "人事部",
    content: `# 給与管理フロー

## 概要
陸上職・海上職の月次給与計算、賞与計算、年末調整の業務フロー。海上職は航海日数・乗船手当等の変動要素が多く計算が複雑。約500名分を処理。

## 業務ステップ

### 1. 勤怠データ収集（人事部 + 各部門）
- 陸上職：勤怠システムからデータ抽出（CSV出力）
- 海上職：各船から航海日誌・勤務記録を受領（衛星メール/紙）
- 残業申請の確認・承認状況チェック（部門長承認済みか確認、メール照会）
- 有給休暇取得状況の確認（Excel台帳と勤怠データの突合）
- 勤怠異常値の確認（打刻漏れ、残業過多等をExcelで抽出）
- 各部門への勤怠修正依頼（メール）→修正回答待ち

### 2. 変動項目の収集（人事部）
- 人事異動・昇給情報の反映（人事発令をExcelで確認→手動反映）
- 通勤手当の変更（届出に基づき手動計算・入力）
- 海上職の乗船手当・航海手当計算（航海日数×単価、Excelで計算）
- 家族手当・住宅手当の変更（届出書を確認→手動更新）
- 前月の過不足精算（前月計算ミスの修正、手動）
- 中途入社/退職者の日割計算（手動でExcel計算）

### 3. 給与計算実行（人事部・給与担当）
- 給与計算ソフトへのデータ入力（勤怠CSV取込 + 変動項目の手入力）
- 計算実行・エラーチェック
- 計算結果の検証（前月比較、異常値チェック、Excelで差分確認）
- 社会保険料の控除額確認（標準報酬月額テーブルと照合）
- 所得税の計算確認（税額表との照合）
- 住民税の特別徴収額確認（市区町村からの通知書と照合）

### 4. 承認・確定（人事部長 + 経理部）
- 給与一覧表の作成（給与計算ソフトから出力）
- 人事部長への報告・承認（紙に押印 or メール承認）
- 経理部への振込データ連携（CSVまたは紙渡し）
- 振込データの作成（全銀フォーマット変換）
- 振込実行（インターネットバンキング）
- 振込結果の確認

### 5. 明細配布・届出（人事部）
- 給与明細の作成（給与計算ソフトから印刷 or PDF出力）
- 明細の配布（紙を封筒に入れて各人の机上配布 / 一部PDFメール）
- 社会保険料の納付（銀行振込、月末期限）
- 所得税の納付（翌月10日期限）
- 住民税の納付（翌月10日期限）
- 労働保険料の納付（年度更新時）

### 6. 年次処理（人事部）
- 算定基礎届の作成・提出（7月、標準報酬月額の見直し）
- 月額変更届の作成（固定賃金変動時）
- 賞与計算（年2回、算定基準のExcel計算→計算ソフト入力）
- 賞与支払届の提出（年金事務所）
- 年末調整（従業員から紙の申告書回収→計算ソフト入力→源泉徴収票発行）

## 現在の課題
- 海上職の勤怠データ収集が衛星メール/紙で遅延しがち
- 変動項目の手入力が多くミスのリスクが高い
- 前月比較チェックが目視中心で見落としがある
- 給与明細が紙配布中心で印刷・封入に半日かかる
- 年末調整の紙申告書の回収・入力が膨大な作業量
- 海上職と陸上職で計算ロジックが異なり、属人化している`,
  },
];

async function createProject(wf) {
  const projRes = await fetch(`${BASE}/api/bottleneck/project`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name: wf.name, department: wf.department }),
  });
  const projData = await projRes.json();
  const projectId = projData.project?.id;
  if (!projectId) {
    console.error(`Failed to create project: ${wf.name}`, projData);
    return null;
  }
  console.log(`Created: ${wf.name} -> ${projectId}`);

  const formData = new FormData();
  const blob = new Blob([wf.content], { type: "text/plain" });
  const filename = wf.name.replace(/[・／ ]/g, "_") + ".txt";
  formData.append("file", blob, filename);
  formData.append("projectId", projectId);

  const uploadRes = await fetch(`${BASE}/api/bottleneck/upload`, {
    method: "POST",
    body: formData,
  });
  const uploadData = await uploadRes.json();
  console.log(`  Uploaded: ${uploadData.document?.id || "FAIL"}`);
  return projectId;
}

async function analyzeAndWait(projectId, name) {
  console.log(`\nAnalyzing: ${name}`);
  const res = await fetch(`${BASE}/api/bottleneck/analyze`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ projectId }),
  });
  const data = await res.json();
  if (data.error) { console.log(`  Error: ${data.error}`); return false; }

  for (let i = 0; i < 60; i++) {
    await new Promise(r => setTimeout(r, 5000));
    const s = await (await fetch(`${BASE}/api/bottleneck/analyze?projectId=${projectId}`)).json();
    if (s.status === "completed") { console.log(`  DONE`); return true; }
    if (s.status === "failed") { console.log(`  FAILED: ${s.error}`); return false; }
    if (i % 4 === 0) console.log(`  ...${s.status} (${s.progress}%)`);
  }
  return false;
}

async function main() {
  console.log(`=== Creating ${workflows.length} projects ===\n`);
  const projects = [];
  for (const wf of workflows) {
    const pid = await createProject(wf);
    if (pid) projects.push({ id: pid, name: wf.name });
  }

  console.log(`\n=== Analyzing ${projects.length} projects ===`);
  for (const proj of projects) {
    const ok = await analyzeAndWait(proj.id, proj.name);
    if (!ok) {
      console.log(`  Retrying...`);
      await analyzeAndWait(proj.id, proj.name);
    }
  }
  console.log("\n=== ALL DONE ===");
}

main().catch(console.error);
