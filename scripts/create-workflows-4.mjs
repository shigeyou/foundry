const BASE = "http://localhost:3006";

// 実際のIT環境を前提条件として組み込み
const IT_ENV = `
## 社内IT環境（前提条件）
- 会計: SAP S/4HANA Cloud
- 経費精算: Tokium経費精算 / 楽々精算（部門別）
- 請求書処理: Tokiumインボイス
- 給与: 奉行クラウド
- 人事管理: カオナビ
- 勤怠管理: 勤革時
- オフィス: M365 Enterprise（全社）
- データ管理: SharePoint / OneDrive
- AI: Microsoft Copilot（全社員導入）
- タスク管理: ASANA（約半数の事業部）/ The Board（1部門）
- 見積書: 手作業（Excel→PDF）
- デバイス: ノートPC + スマホ 全社員貸与
`;

const workflows = [
  {
    name: "仕訳入力・月次決算フロー",
    department: "経理部",
    content: `# 仕訳入力・月次決算フロー

## 概要
SAP S/4HANA Cloudを中心とした仕訳入力から月次決算締めまでの業務フロー。Tokiumインボイスからの請求書データ連携、各部門からの経費データ取込、銀行取引の消込を経て月次決算を完了する。

${IT_ENV}

## 業務ステップ

### 1. 日次仕訳入力（経理部）
- Tokiumインボイスで受領した請求書データをSAP S/4HANAに取込（一部手動連携）
- Tokium経費精算/楽々精算の精算データをSAPに仕訳計上（CSV取込 or 手入力）
- 銀行取引明細のダウンロード（インターネットバンキングからCSV）
- 入出金の仕訳入力（SAPに手入力、取引量により1日50〜100件）
- 仮払金・前払金の管理（Excelで期日管理、SAPの残高と照合）
- 部門間取引の仕訳（内部振替、SAPで入力）

### 2. 月末整理仕訳（経理部）
- 未払費用・未収収益の計上（各部門にメールで照会→回答待ち→仕訳入力）
- 減価償却費の計上（SAPの固定資産モジュールで自動計算→確認→転記）
- 引当金の見直し・計上（賞与引当、修繕引当等、Excel算出→SAP入力）
- 前払費用の月割計上（SAPで定期仕訳設定、一部手動）
- 外貨建取引の為替換算（月末レートをSAPに設定、評価替仕訳を自動生成）
- 連結用データの作成（親会社フォーマットのExcelに転記）

### 3. 勘定照合・残高確認（経理部）
- 銀行残高と帳簿残高の照合（通帳/IBの残高とSAP残高を目視比較）
- 売掛金の入金消込（振込名義と請求先を手動マッチング）
- 買掛金の残高確認（取引先との残高確認書をメール/FAXで送付→回収→照合）
- 仮勘定残高の精査（仮払金、仮受金等の内容確認、担当部門にメール照会）
- 未達取引の確認（銀行未達、部門未達をExcelリストで管理）
- 勘定間の整合性チェック（BSとPLのバランス、SAPのレポートで確認）

### 4. 月次決算締め・報告（経理部 + 経営層）
- 試算表の出力・検証（SAP標準レポート + Excelで前月比較分析）
- 異常値・差異の調査（前月比10%以上変動の勘定科目を洗い出し）
- 月次決算報告資料の作成（Excel + PowerPoint）
- 経営会議への報告（月次PL、BS、キャッシュフロー概況）
- 予算実績比較表の作成（予算データExcelとSAP実績を突合）
- 部門別損益の集計・配信（各部門長にメール送付）

### 5. 期末決算（年次）（経理部 + 監査法人）
- 年度末の決算整理仕訳（引当金確定、棚卸資産評価等）
- 監査法人への資料提出（SharePointで共有 or 紙ファイル提出）
- 監査指摘事項への対応
- 税務申告書の作成（税理士事務所と連携）
- 有価証券報告書データの準備（該当する場合）

## 現在の課題
- TokiumインボイスとSAPのデータ連携が完全自動ではなく手動介在が必要
- 経費精算ツール（Tokium/楽々精算）が2種類あり、SAPへの取込処理も2パターン必要
- 売掛金の入金消込が振込名義の揺れで自動マッチングが困難
- 月末整理仕訳の元データ収集がメールベースで遅延しがち
- 連結用データの作成がExcel手作業で転記ミスのリスクがある
- 予算実績比較がExcelベースで、リアルタイムの予実管理ができない`,
  },
  {
    name: "固定資産管理フロー",
    department: "経理部",
    content: `# 固定資産管理フロー

## 概要
固定資産（有形・無形）の取得から除却・売却までのライフサイクル管理。SAP S/4HANA Cloudの固定資産モジュールを使用しているが、現物管理や棚卸は手動。船舶関連の大型資産も含む。

${IT_ENV}

## 業務ステップ

### 1. 資産取得（経理部 + 購買部門）
- 購入稟議の決裁完了を確認（決裁番号と照合）
- 納品・検収の確認（現場から検収書を受領、メール or 紙）
- 固定資産台帳への登録（SAPの固定資産マスタに入力）
- 資産番号の採番（SAP自動採番）
- 資産ラベルの作成・貼付（ラベルプリンタで印刷→現物に貼付）
- 設置場所・管理部門の登録（SAP + 管理用Excel台帳にも二重入力）
- 取得仕訳の計上（SAPで自動仕訳）

### 2. 減価償却管理（経理部）
- 償却方法・耐用年数の設定（SAPマスタに入力、税法ベース）
- 月次減価償却費の自動計算（SAPの月次バッチ処理）
- 償却結果の確認・転記（経理担当が確認後に本転記）
- 特別償却・減損の判定（該当資産のExcelリストで管理）
- 減損テスト（年次、キャッシュフロー分析をExcelで実施）

### 3. 現物管理・棚卸（経理部 + 各部門）
- 年次棚卸計画の策定（対象拠点、日程、担当者をExcelで計画）
- 棚卸リストの出力（SAPから資産一覧を出力→印刷）
- 現物確認の実施（紙のリストを持って各フロアを巡回、目視確認）
- 確認結果の記入（紙のリストにチェック・コメント記入）
- 棚卸結果の入力（紙からExcelに転記→SAPと照合）
- 不一致の調査・修正（紛失・移動・廃棄漏れの確認）

### 4. 資産異動（経理部 + 各部門）
- 部門間移動の申請（紙の異動申請書 or メール）
- SAP台帳の管理部門・設置場所変更
- 管理用Excel台帳の更新
- 資産ラベルの再貼付（必要な場合）

### 5. 除却・売却（経理部 + 総務）
- 除却/売却の稟議決裁
- 除却仕訳の計上（SAPで簿価の除却処理）
- 廃棄の場合は廃棄業者への依頼（総務がメールで手配）
- マニフェスト（産廃の場合）の管理
- 売却の場合は売却益/損の計上
- SAP台帳からの除外処理
- 保険の解約手続き（該当資産の保険をメールで解約依頼）

## 現在の課題
- SAPの固定資産台帳と現物の乖離（移動・廃棄がリアルタイムに反映されない）
- 現物棚卸が紙ベースで効率が悪い（バーコード/RFID未導入）
- 管理用Excel台帳との二重管理が負荷
- 船舶等の大型資産の減損テストが属人的
- 除却手続きが遅れがちで不要資産が台帳に残り続ける`,
  },
  {
    name: "予算策定・管理フロー",
    department: "経営企画部",
    content: `# 予算策定・管理フロー

## 概要
年度予算の策定（ボトムアップ + トップダウン調整）から月次予実管理までの業務フロー。SAPの実績データをベースにExcelで予算編成を行い、承認後にSAPに予算データを登録。

${IT_ENV}

## 業務ステップ

### 1. 予算方針策定（経営企画部 + 経営層）
- 中期経営計画との整合確認
- 経営層から予算方針・重点投資領域の指示受領（会議 + 議事録Word）
- 予算編成スケジュールの策定（Excel）
- 予算編成要領の作成・配布（Word + Excel予算テンプレート）
- 各部門への予算編成依頼（メール配信、テンプレート添付）

### 2. 部門予算作成（各部門）
- 売上予算の作成（営業部門：案件別にExcelで積上げ）
- 人件費予算の計算（人事部提供の人員計画Excelから算出）
- 経費予算の作成（前年実績ベース + 増減要因をExcelで算出）
- 投資予算の作成（設備投資計画をExcelで項目別に積上げ）
- 部門長の確認・承認（Excel予算書に押印 or メール承認）
- 経営企画部への提出（メール + Excel添付）

### 3. 予算調整・審議（経営企画部 + 経営層）
- 部門予算の集約（各部門Excelを経営企画部が統合Excel作成）
- 全社損益・資金繰りのシミュレーション（Excel大規模モデル）
- 経営計画との乖離分析（Excel）
- 予算審議会議の開催（各部門長が参加、PPTで報告）
- トップダウン調整（経営判断による予算カット/追加）
- 各部門への修正依頼（メール）→修正版回収→再集約

### 4. 予算確定・登録（経営企画部 + 経理部）
- 最終予算の経営承認（取締役会付議、紙の稟議書）
- SAP S/4HANAへの予算データ登録（部門別・勘定科目別に手入力）
- 部門別予算書の作成・配布（Excelで部門抜粋→メール配布）
- 予算管理台帳の初期設定（Excel）

### 5. 月次予実管理（経営企画部 + 各部門）
- SAP実績データの抽出（月次決算後にSAPからCSV出力）
- 予算対比表の作成（Excelで予算vs実績vs前年の比較表作成）
- 差異分析（予算比10%以上の乖離について原因コメント記入）
- 各部門への差異分析依頼（メール→回答待ち→集約）
- 月次予実報告書の作成（PPT）
- 経営会議での報告
- 必要に応じて予算修正（補正予算の策定、年1〜2回）

### 6. 見通し管理（経営企画部）
- 四半期ごとの業績見通し（フォーキャスト）作成（Excel）
- 着地見込みのシミュレーション
- 業績予想の修正判断（IR対応が必要な場合）
- 経営層への報告

## 現在の課題
- 予算編成がExcel中心で、部門間の整合性チェックが手動
- 各部門のExcelフォーマットが微妙に異なり集約に手間
- SAPへの予算データ登録が手入力で転記ミスのリスク
- 月次の予実比較がSAP出力→Excelで手動突合
- 予算シミュレーション（what-if分析）がExcelの限界で複雑化
- 見通し管理が属人的で、感覚的な予測になりがち`,
  },
  {
    name: "出張申請・精算フロー",
    department: "全社",
    content: `# 出張申請・精算フロー

## 概要
国内・海外出張の申請→承認→手配→精算の一連の業務フロー。海事業界特有の船舶訪問・港湾出張が多い。経費精算はTokium経費精算または楽々精算を使用（部門により異なる）。

${IT_ENV}

## 業務ステップ

### 1. 出張申請（申請者 + 上長）
- 出張計画の検討（目的、訪問先、日程、同行者）
- 出張申請書の作成（社内フォーマットExcel or ワークフローシステム）
- 概算費用の算出（旅費規程に基づき宿泊費・交通費の上限確認）
- 上長の承認（メール承認 or 紙押印）
- 海外出張の場合は役員承認が追加で必要（稟議書）

### 2. 手配（申請者 or 総務）
- 航空券の手配（指定の旅行代理店にメール依頼 or オンライン予約）
- ホテルの予約（出張者自身がオンライン予約、一部は総務が手配）
- 海外の場合はビザ申請、保険加入、外貨両替
- 船舶訪問の場合は代理店への連絡・入港スケジュール確認
- 仮払金の申請（必要な場合、経理部にメール → 振込）

### 3. 出張実施（出張者）
- 領収書の収集・保管（紙、なくさないように注意）
- 交通系ICカードの利用履歴メモ
- 海外の場合は外貨レシートの保管

### 4. 出張精算（出張者 + 経理部）
- Tokium経費精算 or 楽々精算に経費データ入力
- 領収書の撮影・アップロード（スマホ、Tokiumの場合）
- 紙の領収書を台紙に貼付（楽々精算の部門は紙提出も必要）
- 日当・宿泊費の計算（旅費規程に基づき自動 or 手動計算）
- 上長の精算承認（Tokium/楽々精算のワークフロー or メール）
- 経理部の最終チェック（領収書と申請内容の突合）
- 差し戻しの場合は修正→再提出

### 5. 振込・計上（経理部）
- 精算金額の確定
- 給与と同時精算 or 別途振込（奉行クラウドに連携 or IB振込）
- SAP S/4HANAへの仕訳入力（部門・プロジェクトコード別）
- 仮払金との精算処理
- 法定保存書類の保管

### 6. 出張報告（出張者 + 上長）
- 出張報告書の作成（Word or メール本文）
- 上長への報告（メール提出）
- 成果物・議事録等の共有（SharePoint or メール）

## 現在の課題
- 経費精算ツールが2種類（Tokium/楽々精算）で部門によりフローが異なる
- 領収書の紙提出が一部残っており、電子化が不完全
- 出張申請→承認→精算が別々のシステム/フローで一気通貫でない
- 仮払金の管理が手動で、精算漏れ・遅延が発生
- 海外出張の外貨レート計算が手動
- SAPへの仕訳連携が自動ではなく手入力箇所あり`,
  },
  {
    name: "船舶保険管理フロー",
    department: "海事業務部",
    content: `# 船舶保険管理フロー

## 概要
管理船舶のP&I保険（船主責任保険）、船体保険（Hull & Machinery）、戦争保険等の手続き。年次更新、保険金請求（クレーム処理）、保険条件の見直しを行う。保険ブローカーとの折衝、船主への報告が中心。

${IT_ENV}

## 業務ステップ

### 1. 保険更新準備（海事業務担当 + 船主）
- 更新期日の管理（Excel台帳で管理、通常2月20日がP&I更新日）
- 船隊リスト・船舶情報の更新（トン数、船齢、航路等をExcelで最新化）
- 過去のクレーム実績の集計（Excel台帳から抽出）
- 安全管理実績の整理（事故報告書、PSC指摘件数等）
- 保険ブローカーへの更新情報提供（メール + Excel添付）
- 船主の意向確認（保険条件の変更希望、メール/会議）

### 2. 見積・交渉（海事業務担当 + 保険ブローカー）
- 保険ブローカーから見積の取得（メール）
- P&I Club / 保険会社からの条件提示の確認
- 保険料の比較分析（Excelで複数見積を比較表作成）
- 船主への提案書作成（Word/PPT）
- 船主の承認取得（メール）
- カバー範囲・免責事項の最終確認
- 保険契約の締結（保険証券の確認・受領）

### 3. 保険金請求（クレーム処理）（海事業務担当）
- 事故・損害発生の通知受領（船長/船舶管理会社からメール/電話）
- P&I Clubへの事故通知（メール、所定フォーマット）
- 船体保険会社への通知（保険ブローカー経由、メール）
- 事故報告書の作成（Word、船からの情報を基に作成）
- サーベイヤー手配（検査員の派遣依頼、保険会社/ブローカーと調整）
- 損害額の見積・書類収集（修理見積書、写真、証拠書類）
- 保険金請求書の作成・提出（所定フォーマット + 添付書類）
- 保険会社との交渉（査定結果の確認、追加情報の提供）
- 保険金受領・船主への精算報告

### 4. 保険台帳管理（海事業務担当）
- 保険証券の管理（PDFで保管 + 紙原本をキャビネット）
- 船舶ごとの保険内容一覧の維持（Excel台帳）
- 保険料支払スケジュール管理（分割払いの場合、Excel + Outlook予定表）
- クレーム履歴の記録（Excel台帳、案件ごとにシート）
- 年度末の保険コスト集計・分析（Excel）

### 5. 保険条件見直し（海事業務担当 + 船主）
- 船舶売買・新造時の保険手配
- 航路変更時の保険条件変更（戦争保険エリアの追加等）
- 法令改正への対応（海洋汚染保険の強化等）
- 保険ブローカーとの定期ミーティング（年2回程度）

## 現在の課題
- 保険証券・条件の管理がExcel + 紙ファイルで横断検索が困難
- クレーム処理の進捗管理がメールベースで抜け漏れリスク
- 複数船舶の保険更新が同時期に集中し、業務が繁忙
- 保険料の比較分析がExcel手作業で時間がかかる
- クレーム履歴のデータ分析（傾向・予防策）が不十分
- 属人的な知識（ブローカーとの関係、交渉のコツ）が組織知化されていない`,
  },
  {
    name: "船級検査対応フロー",
    department: "海事業務部",
    content: `# 船級検査対応フロー

## 概要
船級協会（ClassNK、Lloyd's Register等）による定期検査の対応業務。船級維持のためには5年周期の各種検査（年次検査、中間検査、定期検査/特別検査）を受検する必要がある。検査不適合の場合は是正対応が必要。

${IT_ENV}

## 業務ステップ

### 1. 検査計画（海事業務担当 + 船舶管理会社）
- 管理船舶の検査予定一覧の確認（Excel台帳、船級協会のWebポータルも参照）
- 検査種類の確認（年次検査、中間検査、特別検査/入渠検査、臨時検査）
- 検査ウィンドウ期間の確認（検査期日の前後3ヶ月が通常の受検期間）
- 船の運航スケジュールとの調整（寄港予定、入渠予定と合わせる）
- 船級協会への検査申請（Webポータル or メール）
- 検査員の派遣依頼・日程調整（船級協会とメール/電話）
- 検査費用の見積確認

### 2. 検査準備（船舶管理会社 + 船）
- 検査項目チェックリストの作成（過去の指摘事項も含む、Excel）
- 船上での事前準備指示（衛星メールで船長に指示）
- 必要書類の準備（前回検査報告書、図面、証書類）
- 入渠検査の場合はドック（造船所）の手配
- 修繕工事の見積取得（造船所から見積、メール/FAX）
- 船主への費用報告・承認取得（メール）

### 3. 検査実施（海事業務担当 + 検査員）
- 検査員の乗船手配（代理店を通じた入国手続き、港までの移動手配）
- 検査立会い（必要に応じて現地出張）
- 検査中の不適合事項への対応協議
- 追加検査・再検査が必要な場合の調整
- 入渠検査の場合は修繕工事の監督

### 4. 検査結果対応（海事業務担当）
- 検査報告書の受領（船級協会からPDF or 紙）
- 不適合事項（Condition of Class）の確認
- 是正期限の管理（Excel台帳に期限を記入）
- 是正措置の計画・実施フォロー（船舶管理会社にメール指示）
- 是正完了の報告（船級協会にメール + 写真・書類提出）
- 船級証書の更新・受領

### 5. 記録管理・分析（海事業務担当）
- 検査結果の台帳記録（Excel、船ごとに検査履歴シート）
- 不適合事項のトレンド分析（共通的な指摘の傾向把握、四半期Excel集計）
- 検査コストの集計・分析（Excel）
- 船主への定期報告（PPT/Excel、四半期or半期）
- 次回検査の計画への反映

## 現在の課題
- 検査スケジュール管理がExcel台帳で、期限の見落としリスク
- 船級協会のWebポータルと自社のExcel台帳の二重管理
- 検査準備の指示が衛星メールベースで詳細な情報共有が困難
- 不適合事項の是正進捗管理がメールベースで追跡が煩雑
- 複数船舶の検査が同時進行すると管理が破綻しがち
- 過去の検査データ活用（予防保全への活用）が不十分`,
  },
  {
    name: "PSC対応フロー",
    department: "海事業務部",
    content: `# PSC（Port State Control）対応フロー

## 概要
寄港国の海事当局によるPSC検査（ポートステートコントロール）への対応業務。IMO条約の遵守状況を検査される。拘留（Detention）を受けた場合は運航停止となるため、迅速な対応が最重要。年間30〜50件の検査対応。

${IT_ENV}

## 業務ステップ

### 1. PSC検査通知・初動（海事業務担当）
- 船からのPSC検査開始通知受領（衛星メール or 代理店経由の電話/メール）
- 検査状況のリアルタイム把握（船長・代理店と連絡を取り合う）
- 社内関係者への情報共有（メール、上長・船舶管理チーム）
- 必要書類のバックアップ確認（証書類のPDFコピーをSharePointから検索）
- 過去のPSC検査履歴確認（Excel台帳 + EQUASIS等の外部DB）

### 2. 検査中対応（海事業務担当 + 船長）
- 船長からの検査進捗報告受領（衛星メール、短文で状況報告）
- 指摘事項（Deficiency）の即時把握
- 技術的な質問への回答・サポート（船舶管理会社の技術部門に照会→回答→船に伝達）
- 代理店との連絡調整（現地サポート手配）
- 拘留リスクの判断（指摘の重大度を評価）

### 3. 指摘事項対応（海事業務担当 + 船舶管理会社）
- PSC検査報告書の受領（検査官から船長経由、紙 or PDF）
- 指摘事項の分析・分類（軽微 / 重大 / 拘留条件）
- 是正計画の策定（修繕内容、必要部品、対応期限）
- 拘留の場合：
  - 即時是正措置の手配（修理業者・部品手配、代理店経由）
  - 船級協会への通知・再検査手配
  - 船主への報告（メール + 電話、拘留は重大事案）
  - 拘留解除に向けた旗国・船級との連絡調整
- 軽微指摘の場合：
  - 次回寄港までの是正計画作成
  - 是正完了期限の管理（Excel台帳）

### 4. 是正完了・報告（海事業務担当）
- 是正措置の実施確認（船からの完了報告、写真・書類）
- 船級協会の再検査（必要な場合）→結果受領
- PSC検査当局への是正完了報告（代理店経由 or メール）
- 船主・船舶管理会社への完了報告（メール + 報告書Word）
- 社内報告書の作成（再発防止策を含む、Word）

### 5. 分析・予防（海事業務担当）
- PSC検査結果のデータベース化（Excel台帳に記録）
- 指摘事項のトレンド分析（四半期、Excel）
- 共通指摘事項に対する船隊全体の予防措置検討
- 乗組員への注意喚起資料作成・配布（Word/PPT、メール送信）
- 旗国・船級への報告（重大案件の場合）
- KPI管理（PSC拘留率、指摘件数等のExcel集計）

## 現在の課題
- 検査通知が突発的で、初動の対応フローが標準化されていない
- 衛星メールでの情報交換が遅く、リアルタイム性に欠ける
- 指摘事項の是正進捗管理がメール + Excel台帳で追跡が困難
- 過去のPSC検査データの分析が手動で、傾向の早期把握ができない
- 複数港で同時にPSC検査が発生すると対応が逼迫
- 拘留時の緊急対応フローが属人的で、マニュアル化が不十分`,
  },
  {
    name: "環境規制対応フロー",
    department: "海事業務部",
    content: `# 環境規制対応フロー

## 概要
IMO（国際海事機関）の環境規制への対応業務。SOx規制（IMO2020）、EEXI/CII（エネルギー効率規制）、バラスト水管理、GHG排出規制等。規制は年々強化されており、対応の遅れは運航停止リスクに直結。

${IT_ENV}

## 業務ステップ

### 1. 規制動向モニタリング（海事業務担当）
- IMO会議（MEPC等）の結果確認（IMOウェブサイト、業界紙、船級協会のニュースレター）
- 新規制・規制改正の要約作成（Word）
- 社内関係者への情報共有（メール配信）
- 管理船舶への影響分析（対象船舶の特定、ExcelでリストアップAF
- 船主への規制情報提供（メール + 解説資料Word/PPT）
- 対応方針の検討・提案（技術的オプションの比較、Excelで費用分析）

### 2. EEXI/CII対応（海事業務担当 + 船舶管理会社）
- 各船のEEXI（エネルギー効率既存船指標）計算（Excelベースの計算ツール）
- EEXI不適合船の改善策検討（EPL、シャフトジェネレータ、省エネ装置等）
- CII（炭素集約度指標）の年次計算（燃料消費データを集計、Excel）
- CII格付け（A〜E）の確認と改善計画策定
- SEEMP Part III（船舶エネルギー効率管理計画書）の作成・更新（Word）
- 旗国への提出書類作成
- 船級協会での承認取得

### 3. SOx規制対応（海事業務担当）
- 適合油（低硫黄燃料油）の使用管理
- スクラバー装置搭載船の排水モニタリングデータ管理
- 燃料油サンプリング記録の管理
- ECA（排出規制海域）の航路管理

### 4. バラスト水管理（海事業務担当）
- バラスト水管理装置（BWMS）の搭載スケジュール管理（Excel台帳）
- BWMS搭載工事の手配・監督
- バラスト水管理計画書の作成・承認
- 定期的なBWMSの作動確認・メンテナンス管理

### 5. GHG排出データ報告（海事業務担当 + 船舶管理会社）
- 各船の燃料消費データ収集（船から月次で衛星メール送信→Excelに手入力）
- 年間CO2排出量の集計（Excel計算）
- IMO DCS（データ収集システム）への報告データ作成
- EU MRV（EU域内航海の場合）への報告データ作成
- 第三者検証機関による検証対応（書類提出、ヒアリング対応）
- 各旗国への報告書提出

### 6. 記録管理・コンプライアンス（海事業務担当）
- 環境関連証書の管理（Excel台帳 + 紙ファイル）
- 規制対応状況の一覧管理（船舶ごとのマトリクス、Excel）
- 社内環境報告書への貢献（データ提供）
- 船主・関係者への年次コンプライアンスレポート（PPT/Word）

## 現在の課題
- 規制動向のモニタリングが属人的で、情報の共有・蓄積が不十分
- CII計算のための燃料消費データ収集が衛星メール + 手入力で遅延・ミスリスク
- 複数の規制（EEXI, CII, SOx, バラスト水, GHG）の対応状況を横断管理する仕組みがない
- 各旗国・EUへの報告フォーマットが異なり、データ変換が手作業
- GHGデータの第三者検証対応が膨大な書類準備を要する
- 規制の急速な変化に対応するための組織的な体制が未整備`,
  },
  {
    name: "海技資格管理フロー",
    department: "海事業務部",
    content: `# 海技資格管理フロー

## 概要
船員が保有する海技免状（船長、機関長、航海士、機関士等の資格証明）の有効期限管理、更新手続き、新規取得支援。STCW条約に基づく国際基準の資格管理。管理対象船員約200名、1人あたり5〜10種の証書を保有。

${IT_ENV}

## 業務ステップ

### 1. 資格台帳管理（海事業務担当 + 人事部）
- 船員の保有資格一覧の管理（Excel台帳、船員1人1シート）
- 資格の有効期限管理（Excel台帳で期限日を管理、3ヶ月前にアラート）
- カオナビの人事データとの照合（資格情報の二重管理状態）
- 新規採用船員の資格情報登録（入社時に証書コピーを受領→Excelに入力）
- 資格コピーの保管（PDF化してSharePoint保存 + 紙ファイル）

### 2. 更新手続き（海事業務担当 + 船員本人）
- 更新対象者への通知（メール、乗船中の場合は衛星メール）
- 更新講習の受講手配（海技教育機構等の講習予約）
- 講習スケジュールと乗下船予定の調整
- 更新申請書の作成（地方運輸局所定様式に記入）
- 必要書類の収集（健康診断書、講習修了証、写真等）
- 地方運輸局への申請（窓口持参 or 郵送）
- 新免状の受領・本人への引渡し
- 台帳の更新（Excel + SharePointのPDF）

### 3. 新規資格取得支援（海事業務担当 + 人事部）
- キャリアプランに基づく資格取得計画（上長・人事と相談）
- 受験要件の確認（乗船履歴、座学履歴等、Excel台帳と照合）
- 乗船履歴証明書の作成（運輸局様式に記入）
- 試験申込手続きの支援
- 合格後の免状申請手続き

### 4. STCW関連証書管理（海事業務担当）
- STCW条約に基づく各種証書の管理
  - 基本安全訓練証書
  - 上級消火訓練証書
  - 救命艇手証書
  - 医療管理者証書 等
- 各証書の有効期限管理（Excel台帳）
- 更新講習の手配
- 外国籍船に乗船する場合のFlag State Endorsement取得

### 5. コンプライアンス管理（海事業務担当）
- 配乗前の資格適合性確認（船の種類・トン数と船員の保有資格の照合）
- MLC（海上労働条約）の資格要件充足確認
- 旗国の追加要件の確認・対応（旗国ごとに異なる追加資格要件）
- ISM監査での資格管理状況の提示
- PSC検査での船員資格確認への対応

## 現在の課題
- 200名×5〜10種の証書をExcel台帳で管理しており、期限管理の見落としリスク大
- カオナビの人事データとExcel資格台帳の二重管理で情報の不整合が発生
- 乗船中船員への連絡が衛星メールに限られ、更新手続きの遅延が発生
- 更新講習の予約が先着順で、希望日程が取れないことがある
- STCW関連の証書が多岐にわたり、全体像の把握が困難
- 旗国ごとの追加要件がベテラン担当者の知識に依存（属人化）`,
  },
  {
    name: "ISO/ISM監査対応フロー",
    department: "安全管理部",
    content: `# ISO/ISM監査対応フロー

## 概要
ISO9001（品質マネジメント）、ISO14001（環境マネジメント）、ISMコード（国際安全管理コード）の内部監査・外部監査対応業務。年間計画に基づく内部監査の実施と、認証機関・旗国による外部監査への対応。

${IT_ENV}

## 業務ステップ

### 1. 年間監査計画（安全管理部）
- 年間内部監査計画の策定（対象部門/船舶、時期、監査員をExcelで計画）
- 外部監査の予定確認（認証機関・旗国の検査スケジュール）
- 監査チームの編成（内部監査員の資格保有者から選定）
- 監査計画書の作成（Word）→経営層承認（メール or 押印）
- 各部門・船舶への監査計画通知（メール）

### 2. 内部監査準備（監査チーム）
- 前回監査の指摘事項・是正状況の確認（過去の監査報告書、紙ファイル参照）
- 監査チェックリストの作成（Excel、ISO/ISM要求事項に基づく）
- 被監査部門の文書・記録の事前レビュー（SharePointの文書管理体系）
- 監査日程の調整（被監査部門とメール/口頭で調整）
- 船舶監査の場合は入港予定・乗船手配の確認

### 3. 内部監査実施（監査チーム + 被監査部門）
- オープニングミーティング（監査目的・範囲の確認）
- 文書審査（マニュアル・手順書と実態の整合性確認）
- 現場確認（作業手順の遵守状況を目視確認）
- インタビュー（担当者への質問で理解度・運用状況確認）
- 船舶の場合は船上での安全管理状況の確認
- 不適合事項の特定・証拠収集
- クロージングミーティング（指摘事項の報告）

### 4. 監査報告・是正（安全管理部 + 被監査部門）
- 監査報告書の作成（Word、不適合事項・観察事項・改善推奨事項を記載）
- 被監査部門への報告書送付（メール + 紙コピー）
- 是正措置要求書の発行（不適合事項に対して、Word）
- 被監査部門の是正計画書受領（Word、根本原因分析と対策）
- 是正措置の実施フォロー（メールで進捗確認）
- 是正完了の確認（書類確認 or 現場確認）
- マネジメントレビューへの報告資料作成（PPT）

### 5. 外部監査対応（安全管理部 + 各部門）
- 認証機関の審査日程の確定（メール）
- 審査範囲の確認・準備指示（各部門にメール）
- 提示文書・記録の事前準備（SharePoint + 紙ファイルの整理）
- 審査当日の対応（審査員アテンド、部門別インタビュー調整）
- 審査指摘事項への対応計画作成・提出（Word、期限内に認証機関にメール）
- 是正措置の実施・完了報告
- 認証書の更新・受領

### 6. 文書管理（安全管理部）
- 安全管理マニュアル（SMM）の維持管理（Word文書、版数管理）
- 手順書・チェックリストの改訂管理（SharePoint + 紙の管理版）
- 文書配布管理（最新版の配布先リスト管理、Excel）
- 廃止文書の回収・破棄管理

## 現在の課題
- 監査記録が紙ファイル中心で、過去の指摘事項の検索・トレンド分析が困難
- 是正措置の進捗管理がメールベースで追跡が煩雑
- 文書管理がSharePoint + 紙の二重管理で版数不整合のリスク
- 内部監査員の力量にバラツキがあり、監査品質が不均一
- マネジメントレビューの準備に膨大な手作業（データ集計）が必要
- 船舶の監査は乗船スケジュールに制約され、計画通りに実施できないことがある`,
  },
  {
    name: "情報セキュリティインシデント対応フロー",
    department: "IT部門",
    content: `# 情報セキュリティインシデント対応フロー

## 概要
サイバー攻撃、マルウェア感染、情報漏洩等のセキュリティインシデントが発生した際の検知→初動→封じ込め→復旧→再発防止の対応フロー。M365環境、船舶のOTセキュリティも含む。

${IT_ENV}

## 業務ステップ

### 1. 検知・通報（全社員 + IT部門）
- セキュリティアラートの検知（M365 Defenderの通知、メール）
- 社員からの不審メール・動作の通報（メール or 電話でIT部門に連絡）
- 船舶からのサイバーインシデント報告（衛星メール or 電話）
- インシデント受付・初期トリアージ（IT担当者が深刻度を判定）
- インシデント管理台帳への記録（Excel、日時・通報者・概要）
- 重大インシデントの場合はCISO/経営層への即時報告（電話 + メール）

### 2. 初動対応・封じ込め（IT部門）
- 被害範囲の特定（影響を受けた端末・システム・データの調査）
- ネットワーク隔離（感染端末のLAN切断、VPN遮断）
- アカウントの一時停止（M365管理センターでアカウント無効化）
- マルウェアの種類・侵入経路の調査（ログ分析）
- フォレンジック対応（必要に応じて外部業者に依頼、メール）
- 関連する船舶への注意喚起（衛星メールで全船配信）

### 3. 復旧（IT部門 + 各部門）
- システム・データの復旧（バックアップからのリストア）
- パッチ適用・脆弱性修正
- 端末の再セットアップ（クリーンインストール）
- アカウントのパスワードリセット
- 復旧確認テスト
- ユーザーへの復旧通知（メール）

### 4. 報告・分析（IT部門 + コンプライアンス）
- インシデント報告書の作成（Word、タイムライン・被害状況・対応内容）
- 経営層への報告（会議 + 報告書）
- 個人情報漏洩の場合は個人情報保護委員会への報告
- 取引先への通知（影響範囲に応じて、メール）
- 根本原因分析（RCA、Word）
- 再発防止策の策定・実施計画

### 5. 再発防止・改善（IT部門）
- セキュリティポリシーの見直し（Word文書の改訂）
- 従業員への注意喚起・教育（メール配信、PPT資料）
- 標的型メール訓練の実施（年2回）
- セキュリティツールの追加・設定変更
- インシデント対応手順の改訂
- 定期報告（月次セキュリティレポート、Excel/PPT）

## 現在の課題
- インシデント管理がExcel台帳で、リアルタイムな状況共有が困難
- 船舶のOTセキュリティの知見が不足（IT部門は船舶システムに不慣れ）
- 初動対応フローが標準化されておらず、担当者によって対応にバラツキ
- フォレンジック能力が社内に不足、外部依頼に時間がかかる
- セキュリティ教育の効果測定が不十分
- Microsoft Copilot導入に伴う新たなリスク（データ漏洩リスク）への対応が未整備`,
  },
  {
    name: "顧客クレーム対応フロー",
    department: "営業部",
    content: `# 顧客クレーム対応フロー

## 概要
顧客（船主、船舶管理会社、訓練受講者等）からのクレーム・苦情の受付から解決までの対応業務。サービス品質の改善にもつなげる。年間約50〜80件のクレーム対応。

${IT_ENV}

## 業務ステップ

### 1. クレーム受付（営業部 + 各部門窓口）
- クレームの受領（電話/メール/対面）
- 受付記録の作成（Excel台帳に日時・顧客名・内容・受付者を記入）
- 重大度の初期判定（軽微/中程度/重大/緊急）
- 関連部門への即時連絡（メール or 電話）
- 重大クレームの場合は上長・経営層に即時報告（電話 + メール）
- 顧客への受領確認・初期回答（メール or 電話、24時間以内）

### 2. 調査・原因分析（関連部門）
- 事実関係の確認（関係者へのヒアリング、メール/電話/会議）
- 関連文書・記録の確認（契約書、作業記録、メール履歴等）
- 原因分析（なぜなぜ分析、Excel or Word）
- 責任部門の特定
- 調査結果の報告書作成（Word）

### 3. 対応策検討・実施（関連部門 + 営業部）
- 対応策の検討（社内会議）
- 補償が必要な場合は範囲・金額の検討
- 経営層の承認（補償が伴う場合、稟議書）
- 顧客への回答書作成（Word）
- 顧客との協議・交渉（会議 or メール/電話）
- 合意内容の文書化（覚書・合意書をWord作成）
- 対応策の実施

### 4. クローズ・フォローアップ（営業部）
- 顧客の満足度確認（電話 or メール）
- クレーム管理台帳の完了記入（Excel）
- 対応結果の社内共有（関係部門にメール）
- 再発防止策の策定（Word、関連部門と協議）
- 再発防止策の実施フォロー

### 5. 分析・改善（品質管理担当）
- クレームデータの集計・分析（四半期、Excel）
- クレーム傾向分析（種類別、部門別、顧客別、Excel）
- マネジメントレビューへの報告（PPT）
- ISO9001の改善活動への反映
- サービス品質向上施策の立案

## 現在の課題
- クレーム管理がExcel台帳で、対応状況のリアルタイム把握が困難
- 複数部門にまたがるクレームの責任分界点が曖昧になりがち
- 顧客への初期回答が遅れることがある（担当者不在時）
- 再発防止策の実施フォローが形骸化
- クレームデータの分析が四半期ごとの手動集計で、タイムリーな改善に繋がらない
- 過去の類似クレームの検索が困難（Excel台帳の目視探索）`,
  },
  {
    name: "契約書管理フロー",
    department: "法務・総務部",
    content: `# 契約書管理フロー

## 概要
業務委託契約、秘密保持契約（NDA）、売買契約、サービス契約等の締結から管理・更新・解約までの業務フロー。海事特有の傭船契約、船舶管理委託契約なども含む。年間約200〜300件の契約を管理。

${IT_ENV}

## 業務ステップ

### 1. 契約起案・ドラフト（起案部門 + 法務）
- 契約の必要性判断・起案（起案部門が稟議書作成）
- 契約書ドラフトの作成（Wordテンプレート使用 or 相手方雛形をベースに修正）
- 法務チェック依頼（メールでWord添付、チェック依頼）
- 法務レビュー（リスク条項の確認、修正コメント挿入、Word修正履歴）
- 起案部門との修正協議（メール往復 or 会議）
- 相手方との条件交渉（メール + Word修正版のやり取り、複数ラウンド）

### 2. 承認・締結（起案部門 + 法務 + 経営層）
- 最終版の確定（Word）
- 契約締結稟議の決裁（紙の稟議書に押印回覧）
- 契約金額に応じた決裁権限者の承認
- 契約書の製本（紙、2部作成）
- 代表者押印/電子署名
- 相手方への送付（郵送 or メール）
- 相手方の押印済み契約書の返送受領
- 収入印紙の貼付（必要な場合）

### 3. 契約登録・保管（法務・総務）
- 契約管理台帳への登録（Excel、契約番号・相手先・契約期間・金額等）
- 契約書原本の保管（キャビネットに紙ファイル、番号順）
- 契約書PDFの保存（SharePointにアップロード）
- 関連部門への締結通知（メール、契約内容のサマリ付き）
- 更新期限のリマインダー設定（Outlook予定表に手動登録）

### 4. 契約管理・更新（法務・総務 + 起案部門）
- 更新期限の到来通知（3ヶ月前にリマインダー通知）
- 契約更新の要否判断（起案部門に確認、メール）
- 更新条件の交渉（必要に応じて）
- 更新覚書/契約書の作成・締結
- 台帳の更新
- 自動更新条項がある場合は更新確認のみ

### 5. 解約・終了（法務・総務 + 起案部門）
- 解約通知書の作成（Word）
- 相手方への解約通知送付（書留郵送 or メール）
- 解約に伴う精算処理
- 台帳の終了記入
- 契約書の保存期間管理（法定保存10年、その後廃棄判断）

## 現在の課題
- 契約管理台帳がExcelで、検索・フィルタリングが限定的
- 契約書のWord修正やり取りが複数ラウンドのメール往復で非効率
- 紙の押印回覧に時間がかかる（1〜2週間）
- 電子契約（DocuSign等）が未導入で、紙の製本・郵送が必須
- 更新期限の管理がOutlook依存で、担当者異動時に引継ぎ漏れ
- 過去の契約条件（先例）の検索が困難（SharePoint + 紙ファイル）
- 海事特有の契約（傭船契約等）のレビューに専門知識が必要で属人化`,
  },
  {
    name: "社内ポータル・ナレッジ管理フロー",
    department: "IT部門",
    content: `# 社内ポータル・ナレッジ管理フロー

## 概要
SharePoint/M365を活用した社内ポータルサイト運営とナレッジ管理の業務フロー。社内規程、業務マニュアル、ベストプラクティス、FAQ等の作成・公開・維持管理。Microsoft Copilot導入で社内情報活用の期待が高い。

${IT_ENV}

## 業務ステップ

### 1. ポータルサイト運営（IT部門 + 各部門）
- SharePointポータルの構成管理（サイト構成、ナビゲーション設定）
- トップページの更新（社内ニュース、お知らせ等の掲載）
- 各部門サイトの管理（部門管理者がコンテンツ更新）
- アクセス権限の管理（M365管理センター + SharePoint権限設定）
- 利用状況の分析（SharePointの分析レポート確認、月次）

### 2. 文書管理（各部門）
- 社内規程・マニュアルの作成（Word/PowerPoint）
- 文書のSharePointアップロード
- 版数管理（SharePointのバージョン履歴機能、ただし運用ルールが不統一）
- 文書の承認ワークフロー（一部部門でPower Automateを使用、多くは未設定）
- 廃止文書の管理（削除 or アーカイブ、ルールが曖昧）
- ファイル命名規則の統制（ルールはあるが遵守されていない）

### 3. ナレッジ共有（各部門）
- 業務ノウハウの文書化（Word/OneNote、書く人が限られる）
- FAQ作成・更新（SharePointリスト or Excelで管理、部門ごとにバラバラ）
- 事例・ベストプラクティスの共有（メール配信 or SharePointに掲載）
- 技術情報の蓄積（海事技術の知見、船級規則の解釈等）
- 引継ぎ文書の作成（異動・退職時、Word、質にバラツキ）

### 4. 検索・活用（全社員）
- SharePoint検索で文書を探す（検索精度にムラ）
- Microsoft Copilotを使った情報検索（導入済みだが活用度は部門により差）
- OneDrive内の個人ファイルへのアクセス
- 部門を超えた情報共有のハードル（アクセス権限の壁）
- 過去メールの検索（Outlook検索）

### 5. 運用改善（IT部門）
- SharePointサイト構成の見直し（年次 or 必要に応じて）
- ユーザートレーニング（M365活用研修、年1〜2回）
- Copilotの活用促進（使い方のTips配信、成功事例の共有）
- データ整理・クリーンアップ（不要ファイルの棚卸、年次）
- セキュリティ設定の確認（外部共有設定、DLP設定）

## 現在の課題
- SharePointのサイト構成が部門ごとにバラバラで、全社横断の情報検索が困難
- 文書の版数管理・承認ワークフローが統一されていない
- ナレッジの文書化が属人的で、暗黙知の組織知化が進んでいない
- ファイル命名規則が遵守されず、検索性が低い
- Copilotが導入済みだが、データの整理が不十分でCopilotの回答精度に影響
- 部門間のアクセス権限が厳しすぎて、必要な情報にアクセスできないケースがある
- 退職・異動時のナレッジ引継ぎが不十分`,
  },
  {
    name: "文書管理・承認フロー",
    department: "全社",
    content: `# 文書管理・承認フロー

## 概要
社内文書（規程類、業務マニュアル、報告書、申請書等）の作成から承認、配布、保管、廃棄までのライフサイクル管理。M365を基盤としつつも、紙文書の管理が並行して残っている状態。

${IT_ENV}

## 業務ステップ

### 1. 文書作成（各部門）
- 文書の起案（Word/Excel/PowerPoint）
- テンプレートの利用（SharePoint上のテンプレートライブラリから取得）
- ドラフト作成・内部レビュー（部門内でメール or Teamsで共有→コメント）
- 共同編集（M365の共同編集機能を利用、ただし操作に不慣れな人も多い）

### 2. 承認プロセス（各部門 + 管理部門）
- 承認ルートの確認（文書種類ごとに異なる、規程集をWordで参照）
- Power Automateワークフロー（一部の定型文書のみ設定済み）
- 多くの文書は紙で回覧→押印による承認
- 承認者不在時の代理承認の処理（口頭で了解を得て後日押印、記録が曖昧）
- 差し戻し→修正→再提出のループ
- 承認完了の通知（メール or 口頭）

### 3. 配布・公開（管理部門）
- SharePointへのアップロード（承認済みファイルをアップロード）
- 関連者への配布通知（メール）
- 紙文書の場合は印刷・配布先管理（配布先リストExcelに基づき印刷・配布）
- 旧版の回収・差替（紙の場合、回収依頼→確認）
- 管理番号・版数の管理（Excelの文書管理台帳に記入）

### 4. 保管・検索（管理部門 + 全社員）
- 電子文書：SharePointのドキュメントライブラリに保管
- 紙文書：キャビネットにファイリング（部門別・種類別）
- 文書管理台帳の維持（Excel、文書番号・タイトル・版数・保管場所）
- 文書検索（SharePoint検索 or 台帳Excel検索 or キャビネット目視）
- アクセス権限管理（SharePointの権限設定、部門管理者が設定）

### 5. 改訂・廃棄（管理部門）
- 定期レビュー（年次、対象文書リストをExcelで管理）
- 改訂の必要性判断
- 改訂手続き（作成→承認→配布の再実行）
- 法定保存期間の管理（文書種類ごとの保存期間をExcelで管理）
- 廃棄判定（保存期間満了文書のリスト作成→承認）
- 廃棄処理（シュレッダー or 溶解処理、電子ファイルの削除）
- 廃棄記録の保管

## 現在の課題
- 紙文書と電子文書の二重管理が非効率
- 承認ワークフローの電子化が一部にとどまり、多くが紙回覧
- Power Automateの設定・運用スキルが一部担当者に限られる
- 文書管理台帳（Excel）と実際のSharePoint/紙ファイルの整合性が取れていない
- 版数管理が不統一（SharePointのバージョン機能を正しく使えていない）
- 文書の検索性が低く、必要な文書を見つけるのに時間がかかる
- 法定保存期間の管理が属人的で、廃棄判断が遅れがち`,
  },
  {
    name: "見積書作成・発行フロー",
    department: "営業部",
    content: `# 見積書作成・発行フロー

## 概要
顧客からの見積依頼に対する見積書の作成・承認・発行の業務フロー。操船シミュレータ訓練、海事コンサルティング、船舶管理等のサービス見積。現状はほぼ手作業（Excel→PDF）で対応。

${IT_ENV}

## 業務ステップ

### 1. 見積依頼受付（営業部）
- 顧客からの見積依頼の受領（メール/電話/Web問合せ）
- 依頼内容の確認・ヒアリング（サービス内容、数量、納期等）
- 過去の類似見積の参照（SharePointフォルダを目視探索 or メール検索）
- 見積作成担当者のアサイン

### 2. 見積作成（営業部 + 技術部門）
- 原価情報の収集（技術部門にメールで照会→回答待ち）
- 外注費の見積取得（外注先にメール/電話で見積依頼→回答待ち）
- 単価表・料金表の参照（Excelの料金マスタ）
- 見積金額の算出（Excelテンプレートで計算）
- 利益率の確認（目標利益率との照合、手動計算）
- 見積書の作成（Excelテンプレートに入力）
- PDF変換（Excel→PDF）

### 3. 見積承認（営業部 + 上長）
- 上長への見積承認依頼（メールでExcel/PDF添付）
- 金額に応じた承認ルート（100万円以上は部門長、500万円以上は役員）
- 承認者の確認・押印（紙に印刷して押印 or メールで「OK」返信）
- 差し戻しの場合は修正→再提出
- 大型案件の場合は見積審査会議（会議室で対面、PPTで説明）

### 4. 見積発行・提出（営業部）
- 見積番号の採番（Excel台帳で連番管理）
- 正式見積書の作成（Excel→PDF、会社印は紙に押印→スキャン or 電子印影貼付）
- 顧客への送付（メール添付 or 郵送）
- 見積台帳への記録（Excel、日付・顧客名・金額・有効期限）
- CRMへの登録（ASANA使用部門はASANAに案件登録、その他はExcel管理）

### 5. フォローアップ（営業部）
- 見積提出後のフォロー連絡（電話/メール）
- 見積内容の質疑対応
- 再見積依頼への対応（条件変更による再計算、再度Excel作成→承認）
- 受注/失注の記録（Excel台帳に結果記入）
- 受注の場合は契約書作成フローへ移行

### 6. 分析・改善（営業部）
- 見積実績の集計（四半期、Excel）
- 受注率の分析（見積件数 vs 受注件数、Excel集計）
- 単価・利益率の分析
- 料金表の見直し（年次）

## 現在の課題
- 見積書作成が完全手作業（Excel→PDF）で、作成に30分〜1時間かかる
- 過去の類似見積の検索が困難（フォルダの目視探索）
- 原価情報の収集がメールベースで回答待ちに時間がかかる
- 見積番号の採番がExcel台帳の手動管理で重複リスク
- 承認プロセスが紙回覧 or メールで標準化されていない
- 見積→受注→契約のパイプライン管理が一元化されていない（Excel + ASANA が混在）
- 料金表が複数のExcelに散在し、最新版の管理が困難`,
  },
];

async function createProject(wf) {
  const projRes = await fetch(`${BASE}/api/bottleneck/project`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name: wf.name, department: wf.department }),
  });
  const projData = await projRes.json();
  const projectId = projData.project?.id;
  if (!projectId) {
    console.error(`Failed to create project: ${wf.name}`, projData);
    return null;
  }
  console.log(`Created: ${wf.name} -> ${projectId}`);

  const formData = new FormData();
  const blob = new Blob([wf.content], { type: "text/plain" });
  const filename = wf.name.replace(/[・／ ]/g, "_") + ".txt";
  formData.append("file", blob, filename);
  formData.append("projectId", projectId);

  const uploadRes = await fetch(`${BASE}/api/bottleneck/upload`, {
    method: "POST",
    body: formData,
  });
  const uploadData = await uploadRes.json();
  console.log(`  Uploaded: ${uploadData.document?.id || "FAIL"}`);
  return projectId;
}

async function analyzeAndWait(projectId, name) {
  console.log(`\nAnalyzing: ${name}`);
  const res = await fetch(`${BASE}/api/bottleneck/analyze`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ projectId }),
  });
  const data = await res.json();
  if (data.error) { console.log(`  Error: ${data.error}`); return false; }

  for (let i = 0; i < 60; i++) {
    await new Promise(r => setTimeout(r, 5000));
    const s = await (await fetch(`${BASE}/api/bottleneck/analyze?projectId=${projectId}`)).json();
    if (s.status === "completed") { console.log(`  DONE`); return true; }
    if (s.status === "failed") { console.log(`  FAILED: ${s.error}`); return false; }
    if (i % 4 === 0) console.log(`  ...${s.status} (${s.progress}%)`);
  }
  return false;
}

async function main() {
  console.log(`=== Creating ${workflows.length} projects ===\n`);
  const projects = [];
  for (const wf of workflows) {
    const pid = await createProject(wf);
    if (pid) projects.push({ id: pid, name: wf.name });
  }

  console.log(`\n=== Analyzing ${projects.length} projects ===`);
  for (const proj of projects) {
    const ok = await analyzeAndWait(proj.id, proj.name);
    if (!ok) {
      console.log(`  Retrying...`);
      await analyzeAndWait(proj.id, proj.name);
    }
  }
  console.log("\n=== ALL DONE ===");
}

main().catch(console.error);
