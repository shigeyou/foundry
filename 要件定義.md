# Foundry プロジェクト要件定義

## 1. プロジェクト概要

### 1.1 背景
商船三井マリテックス（MOLMAT）は2025年4月に商船三井グループ内3社が統合して発足。BA2035 Phase2において「収益力改善・キャッシュ創出」が最重要テーマとなっている。

### 1.2 Foundryとは
**Foundry = 鋳造所**

「型（フレームワーク）」に「設定」を流し込むと、新しいアプリが生まれる仕組み。
特定のアプリを1つずつ作るのではなく、**アプリを無限に生み出せるプラットフォーム**。

---

## 2. アーキテクチャ（確定）

### 2.1 全体構成図

```
    ┌─────────────────────────────────────┐
    │          メタファインダー           │  ← 庭師（3本柱の外）
    │  「どんなアプリを作るべきか」を発見  │
    └─────────────────┬───────────────────┘
                      │
                      ▼
              ┌───────┴───────┐
              │ packages/core │  ← 根っこ（共通基盤）
              └───────┬───────┘
                      │
         ┌────────────┼────────────┐
         ▼            ▼            ▼
    ファインダー型  ドラフター型  シミュレーター型  ← 幹（型/フレームワーク）
         │            │            │
         ├─勝ち筋     ├─議事録     ├─投資
         ├─リスク     ├─決裁書     ├─撤退         ← 枝（個別アプリ）
         ├─ニーズ     ├─提案書     ├─競合            設定で無限に追加可能
         └─...        └─...        └─...
```

### 2.2 各層の役割

| 層 | 名前 | 役割 |
|----|------|------|
| 庭師 | **メタファインダー** | 会社情報を読み、「どんなアプリを作るべきか」を発見 |
| 根っこ | **packages/core** | RAG / LLM / DB 共通基盤 |
| 幹 | **3つの型** | ファインダー型 / ドラフター型 / シミュレーター型 |
| 枝 | **個別アプリ** | 設定を流し込んで生成。無限に追加可能 |

### 2.3 3つの型（フレームワーク）

#### ファインダー型（探す・発見する）
```
入力:
  - 評価軸（例: 収益性, 実現性, リスク, ...）
  - プロンプト（例: BA2035文脈で評価）
  - RAGソース

処理:
  - 多軸評価エンジン
  - スコアリング
  - 分析・比較

出力:
  - スコアカード
  - 分析結果
  - 推奨アクション
```

#### ドラフター型（文書を作る）
```
入力:
  - テンプレート（例: 議事録フォーマット）
  - 前提条件（例: 文字起こし、参加者）
  - RAGソース

処理:
  - ドキュメント生成エンジン
  - テンプレート埋め込み
  - RAG参照・整形

出力:
  - ドキュメント
```

#### シミュレーター型（仮定を置いて予測する）
```
入力:
  - 仮定（例: 「この投資をしたら」）
  - シナリオ構造（例: 3年後の収益予測）
  - RAGソース

処理:
  - What-if分析エンジン
  - シナリオ生成
  - 比較・可視化

出力:
  - 予測結果
  - シナリオ比較
```

---

## 3. メタファインダー

### 3.1 位置づけ
- 3本柱（ファインダー/ドラフター/シミュレーター）の**外**にいる存在
- 「庭師」として、どの枝を生やすべきかを決める
- 枝レベルの「ニーズファインダー」とは別物

### 3.2 機能

| 機能 | 説明 |
|------|------|
| 会社情報の読み込み | docs/summaries/ + 機密情報含む追加資料 |
| 課題・ペイン・機会の抽出 | ドキュメントから自動抽出 |
| アプリ候補の提案 | 「こんなファインダー/ドラフター/シミュレーターが必要」 |
| 優先順位付け | インパクト × 実現可能性で評価 |

### 3.3 出力イメージ
```
┌─────────────────────────────────────────────────────┐
│ 発見されたニーズ                                    │
├─────────────────────────────────────────────────────┤
│ 1. [ファインダー] 〇〇ファインダー                   │
│    理由: 御社のドキュメントに「〜」という記述があり...│
│    優先度: ★★★★★                                  │
│                                                     │
│ 2. [ドラフター] 〇〇ドラフター                      │
│    理由: 「〜」が課題として頻出しており...           │
│    優先度: ★★★★☆                                  │
│                                                     │
│ 3. [シミュレーター] 〇〇シミュレーター              │
│    理由: 「もし〜したら」の問いが見られ...           │
│    優先度: ★★★☆☆                                  │
└─────────────────────────────────────────────────────┘
```

### 3.4 処理フロー
```
Step 1: ドキュメント読み込み
  - docs/summaries/ + 追加ドキュメント
  - RAGでベクトル化・インデックス
      ↓
Step 2: 課題・ペイン・機会の抽出
  - LLMで各ドキュメントから抽出
  - 重複排除・グルーピング
      ↓
Step 3: アプリ候補へのマッピング
  - 課題 × 3本柱の型 → どの型で解決できるか
  - 既存候補との照合 + 新規候補の生成
      ↓
Step 4: 優先順位付け
  - インパクト / 頻度 / 実現可能性 で評価
      ↓
Step 5: 結果出力
  - 優先順位付きのアプリ候補リスト
  - 各候補の根拠（どのドキュメントのどの記述から）
```

### 3.5 設計方針
| 項目 | 方針 |
|------|------|
| 分析の深さ | まずは普通レベルで実装、使ってみて調整 |
| インタラクション | あり。「もっと〇〇方面を探って」と追加指示可能 |
| 保存 | 発見結果をDBに保存、履歴を残す |
| 実行への接続 | 下記 Phase で段階的に進化 |

### 3.6 「この枝を作る」の進化パス（紐）

| Phase | 内容 | 開発者関与 | 状態 |
|-------|------|-----------|------|
| **Phase 1** | 仕様書を自動生成 | 必要（実装は開発者） | ← **MVP** |
| **Phase 2** | 設定ファイル生成 → 即使える | 不要（調整のみ） | 将来 |
| **Phase 3** | 完全自動 + 改善ループ | 不要 | 将来 |

**Phase 1（MVP）の出力：**
- アプリの仕様書（評価軸、プロンプト、入出力定義）
- 必要な入力データの一覧
- 想定プロンプトのドラフト

**Phase 2 への移行条件：**
- 型（ファインダー型/ドラフター型/シミュレーター型）が完成
- 設定ファイルを読み込んで動く汎用エンジンができている

**Phase 3 への移行条件：**
- Phase 2 で十分な実績
- ユーザーフィードバックの自動反映ロジック

---

## 4. ビルド順序（確定）

| 順番 | 作るもの | 説明 |
|:----:|----------|------|
| **1** | `packages/core` | RAG / LLM / DB 共通基盤 |
| **2** | **メタファインダー（MVP）** | 会社情報を読み、作るべきアプリを発見 |
| **3** | ファインダー型 + 最初の枝 | メタファインダーの発見に基づく |
| **4** | ドラフター型 + 最初の枝 | 同上 |
| **5** | シミュレーター型 + 最初の枝 | 同上 |
| **6〜** | 枝を追加 | メタファインダーで発見 → 順次追加 |

---

## 5. 技術構成

### 5.1 Monorepo構成
```
foundry/
├── packages/
│   └── core/                    # 共通基盤
│       ├── src/
│       │   ├── rag/             # RAG処理
│       │   ├── llm/             # Azure OpenAI
│       │   ├── db/              # Prisma + SQLite
│       │   └── types/           # 共通型定義
│       └── package.json
│
├── apps/
│   ├── meta-finder/             # メタファインダー
│   ├── finder/                  # ファインダー型 + 各枝
│   ├── drafter/                 # ドラフター型 + 各枝
│   └── simulator/               # シミュレーター型 + 各枝
│
├── docs/
│   ├── *.pdf, *.pptx            # 社内ドキュメント
│   └── summaries/               # 要約済み
│
├── pnpm-workspace.yaml
└── package.json
```

### 5.2 既存技術資産
| 資産 | 内容 |
|-----|------|
| lib/rag.ts | PDF/DOCX/PPTX/CSV対応、キャッシュ機能付き |
| lib/claude.ts | Azure OpenAI統合、JSON Mode対応 |
| lib/db.ts | Prisma + SQLite (libSQL) |
| api/rag/route.ts | ファイルアップロード・テキスト抽出API |

### 5.3 作成済み
| 項目 | 内容 |
|------|------|
| scripts/summarize-docs.mjs | ドキュメント自動要約スクリプト |
| docs/summaries/ | 10ドキュメントの要約 |

---

## 6. 想定される枝（アプリ候補）

### 6.1 ファインダー系
| カテゴリ | アプリ名 | 概要 |
|----------|----------|------|
| 戦略 | 勝ち筋ファインダー | 事業案件をCF起点で評価 |
| 戦略 | M&Aファインダー | 買収候補企業の筋を評価 |
| 戦略 | 市場ファインダー | 新規参入すべき市場を探索 |
| リスク | リスクファインダー | 事業・プロジェクトのリスク特定 |
| リスク | コンプラファインダー | 違反リスクのある業務を探索 |
| 財務 | 投資ファインダー | 投資案件の優先順位付け |
| 財務 | コストファインダー | コスト削減機会の探索 |
| 人材 | 人材ファインダー | 採用候補の適性評価 |
| ... | ... | （メタファインダーで追加発見） |

### 6.2 ドラフター系
| カテゴリ | アプリ名 | 概要 |
|----------|----------|------|
| 社内 | 議事録ドラフター | 文字起こし→議事録 |
| 社内 | 決裁書ドラフター | 関連資料→決裁書・稟議書 |
| 社内 | 報告書ドラフター | 実績データ→週報・月報 |
| 対外 | 提案書ドラフター | 要件→提案書 |
| 対外 | 入札ドラフター | 仕様書→入札書類・報告書 |
| ... | ... | （メタファインダーで追加発見） |

### 6.3 シミュレーター系
| カテゴリ | アプリ名 | 概要 |
|----------|----------|------|
| 投資 | 投資シミュレーター | 「この投資をしたらROIは？」 |
| 投資 | 撤退シミュレーター | 「この事業を撤退したら？」 |
| 競争 | 競合シミュレーター | 「競合がこう動いたら？」 |
| 組織 | 組織シミュレーター | 「この人事をしたら？」 |
| ... | ... | （メタファインダーで追加発見） |

---

## 7. 商船三井マリテックス固有のコンテキスト

### 7.1 解析済みドキュメント
`docs/summaries/` に10ドキュメントの要約を保存済み。

| ドキュメント | 主な内容 |
|------------|---------|
| CSOメッセージ | BA2035 Phase2の方針：収益力改善、勝ち筋のモデル化、キャッシュ創出 |
| 会社概要 | 従業員159名、統合後の組織体制、業績推移（23年度赤字あり） |
| 3Q決算 | 売上▲3.7億円未達、オンサイト事業部の大幅未達、共通費超過 |
| E2Eソリューション | ケーブル船×風力×オフショアの事業間協業戦略 |
| DXの取り組み | MOL PEARL、DarWIN、チェンジリーダー育成 |

### 7.2 既に見えている課題
| 課題 | 詳細 |
|------|------|
| 収益力改善 | 投資の「勝ち筋」をCF起点で検証する仕組みがない |
| 事業間シナジー | 横断協業の収益効果が可視化されていない |
| 予実管理精度 | 部門ごとの差異が大きく、見込み精度に課題 |
| 意思決定スピード | 議事録・決裁書の作成に時間がかかる |
| 統合後のPMI | 3社の業務プロセス・ナレッジ統合が未完 |

---

## 8. 実装計画

### 進捗状況

| Phase | 内容 | 状態 | 備考 |
|-------|------|------|------|
| Phase 1 | 基盤構築（packages/core） | ✅ 完了 | 2026-01-31 |
| Phase 2 | メタファインダー（MVP） | ✅ 完了 | 2026-01-31 |
| Phase 3 | ファインダー型 + 最初の枝 | 🔲 未着手 | |
| Phase 4 | ドラフター型 + 最初の枝 | 🔲 未着手 | |
| Phase 5 | シミュレーター型 + 最初の枝 | 🔲 未着手 | |
| Phase 6〜 | 枝の追加 | 🔲 未着手 | 継続的 |

### Phase 1: 基盤構築 ✅

| # | タスク | 状態 |
|---|--------|------|
| 1-1 | Monorepo初期化（pnpm workspaces） | ✅ |
| 1-2 | packages/core 作成 | ✅ |
| 1-3 | db モジュール移行 | ✅ |
| 1-4 | llm モジュール移行 | ✅ |
| 1-5 | rag モジュール移行 | ✅ |
| 1-6 | types モジュール作成 | ✅ |
| 1-7 | 動作確認 | ✅ |

### Phase 2: メタファインダー ✅

| # | タスク | 状態 |
|---|--------|------|
| 2-1 | apps/meta-finder 作成 | ✅ |
| 2-2 | ドキュメント読み込み機能 | ✅ |
| 2-3 | 課題抽出ロジック | ✅ |
| 2-4 | アプリ候補マッピング | ✅ |
| 2-5 | 優先順位付けロジック | ✅ |
| 2-6 | 結果表示UI | ✅ |
| 2-7 | インタラクション機能 | ✅ |
| 2-8 | 保存機能 | ✅ |
| 2-9 | 仕様書生成機能（Phase 1） | 🔲 ※次フェーズで実装 |

### Phase 3: ファインダー型

**概要**: 既存の「勝ち筋ファインダー」を汎用化し、設定ファイルで新しいファインダーを作れる仕組みにする

**設定ファイル構造**:
```typescript
interface FinderConfig {
  id: string;                    // "winning-strategy", "risk", "investment"
  name: string;                  // "勝ち筋ファインダー"
  description: string;           // 説明文
  evaluationAxes: {              // 評価軸（可変）
    id: string;                  // "revenuePotential"
    name: string;                // "収益ポテンシャル"
    weight: number;              // 30 (重み%)
    description: string;         // 評価基準の説明
    levels: { score: number; description: string }[];  // 1-5のスコア定義
  }[];
  outputFormat: {                // 出力形式
    itemName: string;            // "勝ち筋", "リスク", "投資案件"
    fields: string[];            // ["name", "reason", "howToObtain", "metrics"]
  };
  systemPromptTemplate: string;  // プロンプトテンプレート
}
```

| # | タスク | 状態 | 詳細 |
|---|--------|------|------|
| 3-1 | FinderConfig型定義 | 🔲 | packages/core/src/types/finder.ts |
| 3-2 | FinderEngine実装 | 🔲 | 設定を読み込み、汎用的に評価を実行 |
| 3-3 | 動的フォーム生成 | 🔲 | 設定から入力フォームを自動生成 |
| 3-4 | スコアカード表示 | 🔲 | 評価軸に応じた結果表示 |
| 3-5 | 勝ち筋ファインダー設定 | 🔲 | 既存ロジックを設定ファイル化 |
| 3-6 | /finder/[id] ページ | 🔲 | 設定IDで動的にファインダーを表示 |
| 3-7 | 動作確認 | 🔲 | 既存機能と同等の動作を確認 |

**最初の枝**: 勝ち筋ファインダー（既存機能の移行）

---

### Phase 4: ドラフター型

**概要**: テンプレートと入力材料から文書を自動生成する仕組み

**設定ファイル構造**:
```typescript
interface DrafterConfig {
  id: string;                    // "minutes", "approval", "proposal"
  name: string;                  // "議事録ドラフター"
  description: string;
  inputs: {                      // 入力フィールド定義
    id: string;                  // "transcript", "attendees"
    name: string;                // "文字起こし"
    type: "text" | "textarea" | "file" | "select";
    required: boolean;
    placeholder?: string;
  }[];
  template: {                    // 出力テンプレート
    sections: {                  // セクション定義
      id: string;                // "summary", "decisions", "actions"
      name: string;              // "決定事項"
      prompt: string;            // このセクションを生成するプロンプト
    }[];
  };
  outputFormat: "markdown" | "html" | "pdf";
}
```

| # | タスク | 状態 | 詳細 |
|---|--------|------|------|
| 4-1 | DrafterConfig型定義 | 🔲 | packages/core/src/types/drafter.ts |
| 4-2 | DrafterEngine実装 | 🔲 | テンプレート処理、セクション生成 |
| 4-3 | 動的フォーム生成 | 🔲 | inputs設定から入力フォームを自動生成 |
| 4-4 | 文書プレビュー | 🔲 | リアルタイムプレビュー、編集機能 |
| 4-5 | エクスポート機能 | 🔲 | Markdown/PDF出力 |
| 4-6 | 議事録ドラフター設定 | 🔲 | 最初の枝として議事録生成を実装 |
| 4-7 | /drafter/[id] ページ | 🔲 | 設定IDで動的にドラフターを表示 |
| 4-8 | 動作確認 | 🔲 | 議事録生成のE2Eテスト |

**最初の枝**: 議事録ドラフター（文字起こし → 議事録）

---

### Phase 5: シミュレーター型

**概要**: 仮定を置いて将来を予測し、複数シナリオを比較する仕組み

**設定ファイル構造**:
```typescript
interface SimulatorConfig {
  id: string;                    // "investment", "withdrawal", "competitor"
  name: string;                  // "投資シミュレーター"
  description: string;
  assumptions: {                 // 仮定パラメータ
    id: string;                  // "investmentAmount", "period"
    name: string;                // "投資額"
    type: "number" | "select" | "range";
    unit?: string;               // "万円", "年"
    default?: number | string;
    options?: { value: string; label: string }[];  // selectの場合
    min?: number; max?: number;  // rangeの場合
  }[];
  scenarios: {                   // シナリオ定義
    id: string;                  // "optimistic", "base", "pessimistic"
    name: string;                // "楽観シナリオ"
    description: string;
    modifiers: Record<string, number>;  // パラメータ調整係数
  }[];
  outputs: {                     // 出力指標
    id: string;                  // "roi", "paybackPeriod"
    name: string;                // "ROI"
    unit: string;                // "%"
    formula?: string;            // 計算式（オプション）
  }[];
  comparisonChart: "bar" | "line" | "radar";  // 比較グラフ種別
}
```

| # | タスク | 状態 | 詳細 |
|---|--------|------|------|
| 5-1 | SimulatorConfig型定義 | 🔲 | packages/core/src/types/simulator.ts |
| 5-2 | SimulatorEngine実装 | 🔲 | シナリオ生成、What-if分析 |
| 5-3 | 仮定入力フォーム | 🔲 | スライダー、数値入力の動的生成 |
| 5-4 | シナリオ比較表示 | 🔲 | 複数シナリオの並列表示 |
| 5-5 | 比較グラフ | 🔲 | Chart.jsで可視化 |
| 5-6 | 投資シミュレーター設定 | 🔲 | 最初の枝として投資判断を実装 |
| 5-7 | /simulator/[id] ページ | 🔲 | 設定IDで動的にシミュレーターを表示 |
| 5-8 | 動作確認 | 🔲 | 投資シミュレーションのE2Eテスト |

**最初の枝**: 投資シミュレーター（投資案件のROI/回収期間予測）

---

## 9. context limit対策

**セッションが切れた場合の再開方法：**

1. 新しいセッションを開始
2. 以下を伝える：
   ```
   「C:\Dev\foundry\要件定義.md を読んで、実装の続きをやって」
   ```
3. 私が進捗状況を確認し、次のタスクから再開

---

*最終更新: 2026-01-31*
