// メタファインダー共通プロンプト・型定義・マスターデータ

export interface DiscoveredNeed {
  id: string;
  name: string;
  description: string;
  actions?: string[];
  reason: string;
  financial: number;
  customer: number;
  process: number;
  growth: number;
}

export const MAX_SCORE = 5;

export function normalizeScore(value: number): number {
  if (typeof value !== "number" || isNaN(value)) return 1;
  if (value > MAX_SCORE) {
    return Math.round((value / 10) * MAX_SCORE);
  }
  return Math.max(1, Math.min(MAX_SCORE, Math.round(value)));
}

// ============================
// マスターデータ（テーマ・部門）
// ============================

// 事業テーマ（18テーマ）
export const businessThemes = [
  // 【特別モード】
  { id: "holistic", label: "全部入り（本質探索）", description: "特定の切り口に縛られず、最も本質的なことを探索する", category: "special" },

  // 【A】事業・戦略
  { id: "competitive", label: "競争優位・差別化", description: "他社にない強みをどう築くか、独自のポジショニング", category: "strategy" },
  { id: "innovation", label: "新規事業・イノベーション", description: "新しい価値の創出、事業機会の発見、技術革新", category: "strategy" },
  { id: "portfolio", label: "事業ポートフォリオ・資源配分", description: "何に集中し何を捨てるか、経営資源の最適配分", category: "strategy" },

  // 【B】オペレーション・基盤
  { id: "efficiency", label: "業務効率化・コスト最適化", description: "無駄の削減、プロセス改善、生産性向上", category: "operations" },
  { id: "quality", label: "品質・安全・信頼性", description: "サービス品質、作業安全、顧客からの信頼", category: "operations" },
  { id: "offensive-dx", label: "攻めのDX", description: "デジタル技術による新規事業創出・競争優位性確立・顧客体験向上", category: "operations" },
  { id: "defensive-dx", label: "守りのDX", description: "デジタル技術による業務効率化・コスト削減・リスク低減・既存事業の強靭化", category: "operations" },

  // 【C】人・組織・文化
  { id: "org-design", label: "組織設計・権限委譲", description: "誰が何を決めどう動くか、組織構造と意思決定権限", category: "people" },
  { id: "leadership", label: "リーダーシップ・マネジメント力", description: "管理職の質、部下育成力、チームを導く力", category: "people" },
  { id: "talent", label: "人材獲得・育成・定着", description: "良い人材をどう集め、育て、辞めさせないか", category: "people" },
  { id: "culture", label: "組織文化・心理的安全性", description: "本音が言える風土、失敗から学べる文化、信頼関係", category: "people" },
  { id: "engagement", label: "エンゲージメント・モチベーション", description: "やる気と当事者意識、仕事への没頭、会社への愛着", category: "people" },

  // 【D】意思決定・ガバナンス
  { id: "decision", label: "意思決定の質・スピード", description: "正しく速く決められるか、データに基づく判断", category: "governance" },
  { id: "risk", label: "リスク管理・コンプライアンス", description: "守るべきものを守る、法令遵守、内部統制", category: "governance" },

  // 【E】外部関係・社会
  { id: "customer", label: "顧客価値・関係深化", description: "顧客にとっての存在意義、関係性の強化", category: "external" },
  { id: "partnership", label: "パートナー・エコシステム", description: "外部との協働、アライアンス、共創", category: "external" },
  { id: "sustainability", label: "環境対応・サステナビリティ", description: "GX推進、環境負荷低減、長期的な社会価値", category: "external" },
];

// 部門（14部門）
export const departments = [
  { id: "all", label: "全社", description: "全社共通で活用できる施策" },
  { id: "planning", label: "総合企画部", description: "経営計画・予算編成・事業企画・DX推進企画" },
  { id: "hr", label: "人事総務部", description: "採用・育成・労務・総務・安全衛生" },
  { id: "finance", label: "経理部", description: "決算・予実管理・原価管理・内部統制" },
  { id: "maritime-tech", label: "海洋技術事業部", description: "港湾・係留安全性検討・GXコンサル" },
  { id: "simulator", label: "シミュレータ技術部", description: "シミュレータ維持管理・シナリオ開発" },
  { id: "training", label: "海技訓練事業部", description: "操船・機関・荷役・DP訓練" },
  { id: "cable", label: "ケーブル船事業部", description: "ケーブル船運航・船舶管理" },
  { id: "offshore-training", label: "オフショア船訓練事業部", description: "DPコース・船種別コース運営" },
  { id: "ocean", label: "海洋事業部", description: "研究船運航・観測支援" },
  { id: "wind", label: "洋上風力部", description: "海域調査・O&M支援" },
  { id: "onsite", label: "オンサイト事業部", description: "技術者派遣・艤装支援" },
  { id: "maritime-ops", label: "海事業務部", description: "JG・GC/LC・許認可申請" },
  { id: "newbuild", label: "新造船PM事業本部", description: "建造監理・技術PM・品質工程管理" },
];

// テーマ別の探索視点（バッチ・単発共通で使用）
export const themeAngles: Record<string, string> = {
  // 【特別モード】
  "holistic": `「全部入り」という名前は、逆説的に「何も縛らない」ことを意味します。

コスト削減、売上拡大、リスク管理...といった個別の切り口には、それぞれの限界があります。
その切り口に縛られている限り、見えないものがあるかもしれない。

この探索では、以下の問いに正面から向き合ってください：

**「この部門・この人にとって、今、最も本質的なことは何か？」**

思考のヒント：
- 「やるべきこと」ではなく「やめるべきこと」は何か？
- 10年後に振り返ったとき、今最も重要だったと言えることは何か？
- 表面的な課題の奥にある、本当の問題は何か？
- 誰も言語化できていないが、皆が薄々感じていることは何か？
- 「効率化」や「改善」を超えた、本質的な変化とは何か？

正解は求めていません。
むしろ「正解があるはず」という思い込みを手放し、
この対象に対する深い洞察を得ることが目的です。`,

  // 【A】事業・戦略
  "competitive": `競争優位とは「選ばれる理由」です。
価格で勝負するのか、品質で勝負するのか、スピードで勝負するのか。
あるいは「この会社にしかできないこと」で勝負するのか。

重要なのは「何で戦うか」を明確にし、そこにリソースを集中すること。
すべてで勝とうとすると、どこでも勝てなくなります。

この部門の強み、他社が真似できない資産は何か？
それをどう磨き、どう活かすかを探索してください。`,

  "innovation": `イノベーションは「ゼロから生み出す」だけでなく「既存の掛け合わせ」からも生まれます。
この部門が持つ専門性と、他業界・他部門の知見を組み合わせることで、
まだ誰も見たことのないサービスが生まれる可能性があります。

「失敗しても学びになる」小さな実験を積み重ねられる仕組みも併せて考えてください。
イノベーションの敵は「失敗を許さない文化」です。`,

  "portfolio": `経営資源は有限です。人も、金も、時間も。
だからこそ「何をやるか」より「何をやらないか」の判断が重要になります。

成長事業に投資すべきか、成熟事業を守るべきか。
撤退すべき事業はないか。買収すべき事業はないか。

この部門において「もっと注力すべきこと」と「やめるべきこと」を探索してください。
聖域なく、ゼロベースで考えることが大切です。`,

  // 【B】オペレーション・基盤
  "efficiency": `「本当に必要な作業は何か？」を問い直すところから始めてください。
単なる自動化ではなく、そもそも不要な作業を見つけ出すことが最大のコスト削減です。

「昔からやっているから」「誰かが始めたから」という理由だけで続けている作業はないか？
人がやるべき仕事とシステムに任せるべき仕事の境界線を再定義してください。`,

  "quality": `品質と安全は「当たり前」と思われがちですが、それを維持するコストは決して小さくありません。
問題は、品質維持のための作業が属人化・形骸化していないかということです。

「なぜこの手順が必要なのか」を常に問い直し、本質的な品質向上に集中できる環境を作る。
現場の「気づき」を拾い上げ、組織的な改善につなげる仕組みを考えてください。`,

  "offensive-dx": `攻めのDXとは、デジタル技術を「武器」として使い、競争優位性を築くことです。
重要なのは「他社ができないこと」を見つけること。汎用的な効率化ツールでは差別化になりません。

この部門ならではの専門性、データ、顧客接点を活かし、
「この会社だからこそ提供できる価値」を生み出す施策を大胆に構想してください。`,

  "defensive-dx": `守りのDXは地味に見えますが、経営の根幹を支える重要な取り組みです。
ポイントは「今動いているものを止めない」ことと「将来の変化に備える」ことの両立。

既存業務をデジタル化する際は、単なる電子化ではなく、
業務フロー自体を見直す機会として捉え、「変化に強い仕組み」を設計してください。`,

  // 【C】人・組織・文化
  "org-design": `組織設計の本質は「誰が何を決められるか」を明確にすることです。

権限が集中しすぎると意思決定が遅くなり、分散しすぎると統制が効かなくなる。
現場に任せるべきことと、上が決めるべきことの境界線はどこにあるか？

また、組織の「箱」だけでなく「つながり」も重要です。
部門間の壁を越えて協働できる仕組みがあるか探索してください。`,

  "leadership": `管理職の質が組織の命運を握ります。
優秀なプレイヤーが優秀なマネージャーになるとは限らない。

部下の強みを引き出せているか？成長機会を与えられているか？
適切なフィードバックができているか？心理的安全性を作れているか？

管理職の育成・支援・評価の仕組みに課題はないか探索してください。
「名ばかり管理職」を作らない仕組みが必要です。`,

  "talent": `「良い人が来ない」「良い人が辞める」—これは結果であって原因ではありません。

なぜ来ないのか？—会社の魅力が伝わっていない？報酬が見合わない？成長機会がない？
なぜ辞めるのか？—上司との関係？将来が見えない？仕事がつまらない？評価されない？

採用・育成・評価・配置の一連の流れの中で、どこにボトルネックがあるか。
「この会社で働きたい」「この会社で働き続けたい」と思わせる要素は何かを探索してください。`,

  "culture": `組織文化は「空気」のようなもので、目に見えないが確実に行動に影響を与えます。

本音が言えない空気はないか？失敗を責める文化はないか？
挑戦より保身が優先される風土はないか？上に忖度する習慣はないか？

心理的安全性がなければ、問題は隠され、改善は進まず、イノベーションは生まれません。
「言いたいことが言える」「失敗しても学びに変えられる」組織を作るための施策を探索してください。`,

  "engagement": `エンゲージメントが低い組織では、人は「仕事をこなす」だけになります。
創意工夫は生まれず、問題を見ても見て見ぬふり、改善提案もしなくなる。

エンゲージメントを高めるには：
- 仕事の意味・目的が理解できているか
- 自分の成長を実感できているか
- 貢献が認められ、評価されているか
- 仲間との信頼関係があるか
- 将来の展望が見えているか

これらの観点から、何が欠けているか、どう改善できるかを探索してください。`,

  // 【D】意思決定・ガバナンス
  "decision": `意思決定の質を上げるには、まず「何を決めるべきか」を明確にする必要があります。
データは意思決定を支援しますが、データに意思決定を委ねてはいけません。

選択肢の提示、リスクの可視化、シナリオの比較を通じて、
経営者や現場リーダーが「腹を括る」ための判断材料を提供できる仕組みを考えてください。

また、決めた後の実行とフォローアップも重要です。
「決めっぱなし」になっていないか？振り返りと軌道修正の仕組みはあるか？`,

  "risk": `リスク管理の本質は「想定外をなくすこと」ではなく「想定外に強くなること」です。
完璧な予測は不可能ですが、早期発見・迅速対応・学習改善のサイクルは強化できます。

また、コンプライアンスは「守り」に見えて、実は「攻め」の武器にもなります。
「ルールを守る会社」から「ルールを使いこなす会社」への転換を支援する施策を考えてください。`,

  // 【E】外部関係・社会
  "customer": `顧客対応で最も価値があるのは「問い合わせを減らす」ことではなく「信頼を築く」ことです。

顧客が本当に求めているものは何か？言葉にしていないニーズは何か？
「また頼みたい」と思われる関係を築くには何が必要か？

顧客の声を聴き、分析し、サービス改善につなげる仕組みを探索してください。
顧客との接点を「コスト」ではなく「価値創造の機会」として捉え直すことが重要です。`,

  "partnership": `一社だけでできることには限界があります。
パートナーとの協働、アライアンス、エコシステムの構築が競争力の源泉になる時代です。

どんなパートナーと組むべきか？何を自社でやり、何を外部に委ねるか？
Win-Winの関係をどう構築し、維持するか？

この部門において、外部との連携で生まれる新しい価値を探索してください。`,

  "sustainability": `サステナビリティは「コスト」ではなく「投資」として捉えるべきフェーズに入っています。
環境対応をビジネスチャンスに変える発想が求められます。

CO2削減や資源効率化の取り組みを「見える化」し、顧客や社会への訴求価値に変換する。
長期的な視点で、この部門が社会に提供できる価値は何かを探索してください。`,
};

// 部門別の文脈（バッチ・単発共通で使用）
export const deptContext: Record<string, string> = {
  "all": `全社横断で活用できる施策を構想してください。
部門を超えた情報共有、全社共通の課題解決、組織文化の変革につながるものを優先します。
特定部門でのパイロット運用から始めて、成功事例を横展開する流れも視野に入れてください。`,

  "planning": `総合企画部は会社の羅針盤です。
経営計画の策定、予算編成、事業ポートフォリオの最適化、そしてDX推進の司令塔としての役割を担います。
全社の情報が集まるこの部門だからこそ見える課題、この部門だからこそできる変革があるはずです。`,

  "hr": `人事総務部は「人」に関わるすべての窓口です。
採用・育成・評価・労務管理から、安全衛生、福利厚生まで幅広い業務を担います。
従業員一人ひとりの成長と、組織全体のパフォーマンス向上を両立させる視点で考えてください。`,

  "finance": `経理部は会社の健康状態を数字で表現する部門です。
決算、予実管理、原価管理、内部統制と、正確性と迅速性の両方が求められます。
数字の裏にあるストーリーを読み解き、経営判断に活かせる情報を提供する役割も担います。`,

  "maritime-tech": `海洋技術事業部は、港湾・係留の安全性検討やGXコンサルティングを手がけます。
高度な技術的専門性と、それを分かりやすく伝えるコミュニケーション力の両方が求められます。
技術力を「顧客の安心」に変換するプロセスをAIで強化する可能性を探ってください。`,

  "simulator": `シミュレータ技術部は、訓練用シミュレータの維持管理とシナリオ開発を担います。
リアリティのある訓練環境を提供し、安全な失敗と学びの機会を創出する重要な役割です。
AIを活用して、より効果的な訓練シナリオを生成したり、訓練結果を分析する可能性を考えてください。`,

  "training": `海技訓練事業部は、操船・機関・荷役・DP訓練を提供します。
実践的なスキルを安全に習得させることが使命であり、教育効果の最大化が常に求められます。
訓練生の理解度に応じたカスタマイズや、訓練記録の活用にAIが貢献できる余地があります。`,

  "cable": `ケーブル船事業部は、海底ケーブル敷設船の運航・船舶管理を行います。
特殊な技術と長期間の洋上作業を伴うプロジェクトが多く、計画性と柔軟性の両立が鍵です。
遠隔地からの船舶状況把握や、乗組員のサポートにAIを活用できる可能性を探ってください。`,

  "offshore-training": `オフショア船訓練事業部は、DPコースや船種別コースの運営を担います。
高度な専門性を持つ受講生に対し、実践的かつ効率的な訓練を提供することが求められます。
コース運営の効率化と訓練品質の向上をAIでどう実現できるか考えてください。`,

  "ocean": `海洋事業部は、研究船の運航と観測支援を行います。
科学者や研究機関との協働が多く、正確なデータ収集と柔軟な運航計画が求められます。
研究支援の高度化や、観測データの活用にAIが貢献できる可能性を探ってください。`,

  "wind": `洋上風力部は、成長市場である洋上風力発電の海域調査やO&M支援を手がけます。
新しい市場でのポジション確立と、他社との差別化が重要なフェーズです。
洋上風力特有の課題解決にAIを活用し、競争優位を築く方法を考えてください。`,

  "onsite": `オンサイト事業部は、造船所・船主・海運会社への技術者派遣や艤装支援を行います。
顧客先での信頼構築と、技術者一人ひとりのパフォーマンス向上が事業の根幹です。
派遣技術者のサポートや、顧客との関係強化にAIを活用する可能性を探ってください。`,

  "maritime-ops": `海事業務部は、JG検査対応、GC/LC発給、各種許認可申請など、海事に関わる手続き業務を担います。
専門知識と正確性が求められる業務であり、法規制の変更への対応も欠かせません。
複雑な手続きの効率化や、ナレッジの蓄積にAIを活用できる可能性を考えてください。`,

  "newbuild": `新造船PM事業本部は、建造監理、技術PM、品質工程管理を一貫して担う大規模部門です。
複数の造船所、多岐にわたるステークホルダー、長期にわたるプロジェクトを管理します。
プロジェクト全体の見える化や、リスクの早期発見にAIを活用する可能性を探ってください。`,
};

// ============================
// プロンプト
// ============================

const BASE_PROMPT = `あなたは「メタファインダー」です。
企業の内部ドキュメントと与えられた文脈に基づいて、本質的な課題と打ち手を発見します。

## 重要な原則

**「追加の指示」セクションの内容を最優先してください。**

テーマと対象に応じて、最も価値のある洞察・提案を出力してください。
打ち手は「AIアプリ」に限定しません。組織変革、プロセス改善、人材育成、
新規事業、提携、撤退判断など、あらゆる施策が対象です。

## 具体性の要件（最重要）

**抽象的・一般論的な記述は厳禁です。** 以下を必ず守ってください：

- **name**: 何をするか一目で分かる具体的な施策名。「誰が」「何を」「どう変えるか」を含めること
  ✕ 抽象的な例：「DX推進」「業務改善」「データ活用基盤」「組織強化」
  ○ 具体的にするポイント：対象部門の業務用語やテーマ固有の概念を名称に含める
- **description**: 以下の3点を必ず含めること
  1. **現状の具体的課題**：何がどう問題なのか（数値・事例・部門名を交えて）
  2. **施策の概要**：何を目指すのか、全体像を簡潔に
  3. **期待される成果**：定量的な効果見込み
- **actions**: 「具体的に何をやるか」のアクションリスト（3〜5項目）。各アクションには実行内容・対象範囲・手法を含めること
  ✕ 抽象的な例：「システムを導入する」「業務を効率化する」「体制を整備する」
- **reason**: ドキュメントから読み取れる根拠を引用しつつ、なぜ今この施策が必要かを論理的に説明

## 評価基準：バランススコアカード（BSC）4視点

各アイデアを以下の4視点で評価してください（各1〜5点の整数・5点満点厳守）：

1. **financial（財務視点）**: 収益向上・コスト削減への貢献度
2. **customer（顧客視点）**: 顧客価値・満足度への貢献度
3. **process（業務プロセス視点）**: 業務効率・品質への貢献度
4. **growth（学習と成長視点）**: 人材・組織能力への貢献度

※スコアは必ず1, 2, 3, 4, 5のいずれか。6以上は禁止。
※4視点のバランスを意識し、すべて高評価にならないよう現実的に評価してください。`;

// 単発探索用プロンプト（10〜20件、sourceDocuments・thinkingProcess・summary付き）
export const SINGLE_PROMPT = `${BASE_PROMPT}

## 出力形式（JSON）

{
  "needs": [
    {
      "id": "idea-1",
      "name": "具体的な施策名",
      "description": "現状課題＋施策概要＋期待成果を具体的に記述",
      "actions": ["具体的アクション1", "具体的アクション2", "具体的アクション3"],
      "reason": "ドキュメント根拠に基づく必要性の説明",
      "sourceDocuments": ["参照した情報源（あれば）"],
      "financial": 1-5,
      "customer": 1-5,
      "process": 1-5,
      "growth": 1-5
    }
  ],
  "thinkingProcess": "どのような思考プロセスで発見したか",
  "summary": "分析のまとめ（2-3文）"
}

10〜20件を目安に出力してください。`;

// バッチ探索用プロンプト（固有性重視版）
export const BATCH_PROMPT = `あなたは「メタファインダー」です。
企業の内部ドキュメントに基づき、指定されたテーマと対象部門に特化した課題と打ち手を発見します。

**最重要ルール：このテーマ × この部門でしか出てこない、固有性の高いアイデアを出すこと。**
汎用的な改善案（「DX推進」「業務効率化」「データ活用」「組織強化」等）ではなく、
この組み合わせならではの施策に集中してください。

## 思考ステップ
1. まず「追加の指示」に記載された部門の業務実態と固有の課題を具体的に想像する
2. 次にテーマの視点からその課題を掘り下げる
3. 「他のテーマ・部門の組み合わせでも出てくるアイデア」を除外し、この組み合わせ固有の施策だけを残す

## 出力ルール
- **name**: 何をするか一目で分かる施策名。部門固有の業務用語を含めること
- **description**: 現状課題・施策概要・期待成果を記述
- **actions**: 具体的アクション3〜4つ。対象・手法を明記
- **reason**: なぜ今この部門にこの施策が必要か、ドキュメント根拠を含めて説明
- **BSCスコア**: financial/customer/process/growth 各1〜5の整数（5点満点厳守、6以上禁止）
  ※4視点のバランスを意識し、すべて高評価にならないよう現実的に評価

## 出力形式（JSON）
{
  "needs": [
    {
      "id": "idea-1",
      "name": "施策名",
      "description": "説明",
      "actions": ["アクション1", "アクション2", "アクション3"],
      "reason": "根拠",
      "financial": 3,
      "customer": 4,
      "process": 2,
      "growth": 3
    }
  ]
}

5〜8件を出力してください。`;
